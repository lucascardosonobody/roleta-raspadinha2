<!-- 
================================================================================
ARQUIVO 3: admin.html - Painel Administrativo Completo
================================================================================
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Roleta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: #3498db;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: #fff;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: #fff;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        /* Cards */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        /* Tabelas */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #3498db;
            color: #fff;
            padding: 12px;
            text-align: left;
            font-weight: 700;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Formul√°rios */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #27ae60;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #fff;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }
        }

            /* ============================================
    MENU LATERAL
    ============================================ */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 250px;
        height: 100vh;
        background: linear-gradient(180deg, #6b46c1 0%, #d946a6 100%);
        color: white;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo-icon {
        font-size: 32px;
    }

    .logo-text h2 {
        font-size: 18px;
        font-weight: 700;
        line-height: 1.2;
        margin: 0;
    }

    .version {
        font-size: 11px;
        opacity: 0.7;
    }

    .sidebar-nav {
        flex: 1;
        padding: 20px 0;
        overflow-y: auto;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        transition: all 0.3s;
        border-left: 3px solid transparent;
    }

    .nav-item:hover {
        background: rgba(255,255,255,0.1);
        color: white;
        border-left-color: white;
    }

    .nav-item.active {
        background: rgba(255,255,255,0.15);
        color: white;
        border-left-color: white;
        font-weight: 600;
    }

    .nav-icon {
        font-size: 20px;
    }

    .nav-text {
        font-size: 14px;
    }

    .sidebar-footer {
        padding: 15px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        color: #6b46c1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
    }

    .user-info {
        display: flex;
        flex-direction: column;
    }

    .user-name {
        font-size: 14px;
        font-weight: 600;
    }

    .user-role {
        font-size: 11px;
        opacity: 0.7;
    }

    /* Ajustar conte√∫do principal para dar espa√ßo ao menu */
    body {
        padding-left: 250px;
    }

    .container, .main-content {
        margin-left: 0;
    }

    /* Responsivo */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        body {
            padding-left: 0;
        }
    }

    </style>
</head>
<body>

    <!-- Menu Lateral -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">üé≤</span>
                <div class="logo-text">
                    <h2>Sistema<br>Sorteio</h2>
                    <span class="version">Vers√£o 1.0</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="paineladm.html" class="nav-item active">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Administra√ß√£o</span>
            </a>
            <a href="historico.html" class="nav-item">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text">Hist√≥rico</span>
            </a>
            <a href="indicacoes.html" class="nav-item">
                <span class="nav-icon">üîî</span>
                <span class="nav-text">Indica√ß√µes</span>
            </a>
            <a href="final.html" class="nav-item">
                <span class="nav-icon">üéØ</span>
                <span class="nav-text">P√°gina P√∫blica</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <div class="user-info">
                    <span class="user-name">Admin</span>
                    <span class="user-role">Administrador</span>
                </div>
            </div>
        </div>
    </aside>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>‚öôÔ∏è Painel Administrativo</h1>
            <div>
                <button class="btn btn-primary" onclick="abrirModalNovoSorteio()">
                    ‚ûï Novo Sorteio Agendado
                </button>
                <button class="btn btn-success" onclick="recarregarDados()">
                    üîÑ Atualizar
                </button>
            </div>
        </header>


                <!-- Abas de Navega√ß√£o -->
        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="display: flex; gap: 0; border-bottom: 3px solid #3498db;">
                <button class="tab-button active" onclick="mudarAba('participantes')" style="flex: 1; padding: 15px; border: none; background: #3498db; color: white; cursor: pointer; font-weight: 700; transition: all 0.3s;">
                    üë• Participantes
                </button>
                <button class="tab-button" onclick="mudarAba('premios')" style="flex: 1; padding: 15px; border: none; background: white; color: #2c3e50; cursor: pointer; font-weight: 700; transition: all 0.3s;">
                    üéÅ Pr√™mios
                </button>
                <button class="tab-button" onclick="mudarAba('sorteios')" style="flex: 1; padding: 15px; border: none; background: white; color: #2c3e50; cursor: pointer; font-weight: 700; transition: all 0.3s;">
                    üìÖ Roleta Agendada
                </button>
                <button class="tab-button" onclick="mudarAba('raspadinha')" style="flex: 1; padding: 15px; border: none; background: white; color: #2c3e50; cursor: pointer; font-weight: 700; transition: all 0.3s;">
                    üé∞ Raspadinha Agendada
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="total-participantes">0</h3>
                <p>Participantes</p>
            </div>
            <div class="stat-card">
                <h3 id="total-premios">0</h3>
                <p>Pr√™mios Cadastrados</p>
            </div>
            <div class="stat-card">
                <h3 id="premios-ativos">0</h3>
                <p>Pr√™mios Ativos</p>
            </div>
        </div>

       <!-- Participantes -->
        <div class="card tab-content" id="aba-participantes">
            <h2>üë• Participantes Cadastrados</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>WhatsApp</th>
                            <th>E-mail</th>
                            <th>Data Cadastro</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-participantes">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                Carregando...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

            <!-- Pr√™mios -->
        <div class="card tab-content" id="aba-premios" style="display: none;">
            <h2>üéÅ Gerenciar Pr√™mios</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="abrirModal('modal-novo-premio')">
                    ‚ûï Adicionar Novo Pr√™mio
                </button>
            </div>
            
            <div class="table-container">
                <table id="premiosTable">
                    <thead>
                        <tr>
                            <th>√çcone</th>
                            <th>Nome do Pr√™mio</th>
                            <th>Descri√ß√£o</th>
                            <th>Tipo</th>
                            <th>Probabilidade</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">
                                Carregando pr√™mios...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div> <!-- Fim do card de Pr√™mios -->

    <!-- ============================================
        SORTEIOS AGENDADOS
    ============================================ -->
    <div class="card tab-content" id="aba-sorteios" style="display: none;">
        <h2>üìÖ Sorteios Agendados</h2>
        
        <!-- Bot√£o Novo Sorteio -->
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="abrirModal('modal-novo-sorteio')">
                ‚ûï Novo Sorteio Agendado
            </button>
        </div>

        <!-- Filtros -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Status:</label>
                    <select id="filtroStatusSorteio" onchange="filtrarSorteiosAgendados()" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                        <option value="todos">Todos</option>
                        <option value="pendente">Pendentes</option>
                        <option value="executado">Executados</option>
                        <option value="cancelado">Cancelados</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data Inicial:</label>
                    <input type="date" id="filtroDataInicio" onchange="filtrarSorteiosAgendados()" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data Final:</label>
                    <input type="date" id="filtroDataFim" onchange="filtrarSorteiosAgendados()" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
            </div>
        </div>

        <!-- Tabela de Sorteios -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Data/Hora</th>
                        <th>Pr√™mios</th>
                        <th>Hor√°rios</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabela-sorteios-agendados">
                    <tr>
                        <td colspan="6" class="loading">
                            <div class="spinner"></div>
                            Carregando sorteios...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal: Novo Sorteio Agendado -->
    <div class="modal" id="modal-novo-sorteio">
        <div class="modal-content" style="max-width: 800px;">
            <h2>üìÖ Novo Sorteio Agendado</h2>
            <form onsubmit="salvarSorteioAgendado(event)">
                
                <!-- Data e Hora -->
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>üìÖ Data do Sorteio: *</label>
                        <input type="date" id="dataSorteio" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>üïê Hora In√≠cio do Sorteio: *</label>
                        <input type="time" id="horaInicioSorteio" required>
                    </div>
                    <div class="form-group">
                        <label>üïê Hora Fim do Sorteio: *</label>
                        <input type="time" id="horaFimSorteio" required>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <small style="color: #666; font-size: 0.85em;">
                        ‚ö†Ô∏è O sorteio ficar√° ativo entre a hora de in√≠cio e fim. Os pr√™mios ser√£o distribu√≠dos nos hor√°rios espec√≠ficos configurados abaixo.
                    </small>
                </div>
                <!-- Distribui√ß√£o de Pr√™mios -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #2c3e50;">Distribui√ß√£o de Pr√™mios por Hor√°rio</h3>
                        <button type="button" class="btn btn-primary btn-small" onclick="adicionarHorarioPremio()">
                            ‚ûï Adicionar Hor√°rio
                        </button>
                    </div>
                    
                    <div id="listaHorariosPremios"></div>
                </div>

                <!-- Pr√™mios Dispon√≠veis -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Pr√™mios Cadastrados:</strong>
                    <div id="premiosDisponiveis" style="margin-top: 10px;">
                        Carregando...
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="fecharModal('modal-novo-sorteio')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        üíæ Salvar Sorteio
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Novo Pr√™mio -->
    <div class="modal" id="modal-novo-premio">
        <div class="modal-content">
            <h2>‚ûï Adicionar Novo Pr√™mio</h2>
            <form onsubmit="salvarPremio(event)">
                <div class="form-group">
                    <label>Nome do Pr√™mio:</label>
                    <input type="text" id="input-nome-premio" placeholder="Ex: Tratamento Facial Completo" required>
                </div>
                <div class="form-group">
                    <label>üéÆ Tipo de Pr√™mio: *</label>
                    <select id="input-tipo-premio" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="">Selecione o tipo</option>
                        <option value="roleta">üé° Roleta</option>
                        <option value="raspadinha">üé∞ Raspadinha</option>
                        <option value="ambos">üéØ Ambos (Roleta e Raspadinha)</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Define onde este pr√™mio poder√° ser usado
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="input-ativo-premio" checked>
                        Ativo (dispon√≠vel para sorteio)
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="fecharModal('modal-novo-premio')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================
     ABA: RASPADINHA AGENDADA
     ============================================ -->
        <div class="card tab-content" id="aba-raspadinha" style="display: none;">
            <h2>üé∞ Raspadinhas Agendadas</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="abrirModalNovaRaspadinha()">
                    ‚ûï Nova Raspadinha Agendada
                </button>
            </div>

            <!-- Filtros -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Status:</label>
                        <select id="filtroStatusRaspadinha" onchange="filtrarRaspadinhasAgendadas()" 
                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="todos">Todos</option>
                            <option value="pendente">Pendentes</option>
                            <option value="ativo">Ativos</option>
                            <option value="realizado">Realizados</option>
                            <option value="cancelado">Cancelados</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data Inicial:</label>
                        <input type="date" id="filtroDataInicioRaspadinha" onchange="filtrarRaspadinhasAgendadas()" 
                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data Final:</label>
                        <input type="date" id="filtroDataFimRaspadinha" onchange="filtrarRaspadinhasAgendadas()" 
                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                </div>
            </div>

            <!-- Tabela de Raspadinhas -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Per√≠odo Ativo</th>
                            <th>Pr√™mios</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-raspadinhas-agendadas">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Carregando raspadinhas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    <!-- Modal Editar Pr√™mio -->
    <div class="modal" id="modal-editar-premio">
        <div class="modal-content">
            <h2>‚úèÔ∏è Editar Pr√™mio</h2>
            <form onsubmit="atualizarPremio(event)">
                <input type="hidden" id="edit-premio-id">
                <div class="form-group">
                    <label>Nome do Pr√™mio:</label>
                    <input type="text" id="edit-nome-premio" required>
                </div>
                <div class="form-group">
                    <label>üéÆ Tipo de Pr√™mio: *</label>
                    <select id="edit-tipo-premio" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="">Selecione o tipo</option>
                        <option value="roleta">üé° Roleta</option>
                        <option value="raspadinha">üé∞ Raspadinha</option>
                        <option value="ambos">üéØ Ambos (Roleta e Raspadinha)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-ativo-premio">
                        Ativo (dispon√≠vel para sorteio)
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="fecharModal('modal-editar-premio')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================
     MODAL: Nova Raspadinha Agendada
     ============================================ -->
    <div class="modal" id="modal-nova-raspadinha">
        <div class="modal-content" style="max-width: 800px;">
            <h2>üé∞ Nova Raspadinha Agendada</h2>
            <form onsubmit="salvarRaspadinhaAgendada(event)">
                
                <!-- Data e Hora -->
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>üìÖ Data da Raspadinha: *</label>
                        <input type="date" id="dataRaspadinha" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>üïê Hora In√≠cio: *</label>
                        <input type="time" id="horaInicioRaspadinha" required>
                    </div>
                    <div class="form-group">
                        <label>üïê Hora Fim: *</label>
                        <input type="time" id="horaFimRaspadinha" required>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <small style="color: #666; font-size: 0.85em;">
                        ‚ö†Ô∏è A raspadinha ficar√° ativa entre a hora de in√≠cio e fim. Os pr√™mios ser√£o distribu√≠dos nos hor√°rios espec√≠ficos.
                    </small>
                </div>

                <!-- Distribui√ß√£o de Pr√™mios -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #2c3e50;">Distribui√ß√£o de Pr√™mios por Hor√°rio</h3>
                        <button type="button" class="btn btn-primary btn-small" onclick="adicionarHorarioPremioRaspadinha()">
                            ‚ûï Adicionar Hor√°rio
                        </button>
                    </div>
                    
                    <div id="listaHorariosPremiosRaspadinha"></div>
                </div>

                <!-- Pr√™mios Dispon√≠veis -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Pr√™mios de Raspadinha Cadastrados:</strong>
                    <div id="premiosDisponiveisRaspadinha" style="margin-top: 10px;">
                        Carregando...
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="fecharModal('modal-nova-raspadinha')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        üíæ Salvar Raspadinha
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================
     PAINEL DE SORTEIO AUTOM√ÅTICO
     ======================================== -->
<div class="painel-sorteio-automatico" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
    <h2 style="color: white; margin: 0 0 20px 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 32px;">üé≤</span>
        Sorteio Autom√°tico
    </h2>
    
    <!-- Status atual -->
    <div id="status-sorteio" style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 15px; color: white;">
            <div id="status-badge" style="width: 20px; height: 20px; border-radius: 50%; background: #ff4444;"></div>
            <div style="flex: 1;">
                <div style="font-weight: bold; font-size: 16px;" id="status-texto">Sorteio Desativado</div>
                <div style="font-size: 14px; opacity: 0.9;" id="status-info">Configure abaixo para ativar</div>
            </div>
        </div>
    </div>
    
    <!-- Configura√ß√µes -->
    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
        <div style="margin-bottom: 15px;">
            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">
                üë• Quantos participantes necess√°rios para sortear?
            </label>
            <input 
                type="number" 
                id="participantes-necessarios" 
                min="1" 
                value="10" 
                style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 18px; font-weight: bold; text-align: center;"
                placeholder="Ex: 10"
            >
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button 
                id="btn-sorteio-automatico"
                onclick="executarSorteioAutomatico(event)"
                style="width: 100%; background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;"
            >
                ‚úÖ ATIVAR SORTEIO AUTOM√ÅTICO
            </button>
            
            <button 
                id="btn-desativar-sorteio"
                onclick="executarSorteioAutomatico()"
                style="flex: 1; background: #f44336; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: none;"
                onmouseover="this.style.background='#da190b'"
                onmouseout="this.style.background='#f44336'"
            >
                ‚ùå DESATIVAR SORTEIO AUTOM√ÅTICO
            </button>
        </div>
    </div>
    
    <!-- Progresso -->
    <div id="progresso-sorteio" style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px; display: none;">
        <div style="color: white; margin-bottom: 10px; font-weight: 600;">
            üìä Progresso at√© o pr√≥ximo sorteio:
        </div>
        <div style="background: rgba(255,255,255,0.2); border-radius: 20px; height: 30px; overflow: hidden; margin-bottom: 10px;">
            <div id="barra-progresso" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;"></div>
        </div>
        <div style="color: white; text-align: center; font-size: 18px; font-weight: bold;" id="texto-progresso">
            0 / 10 participantes
        </div>
    </div>
</div>

<style>
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.sorteio-ativo #status-badge {
    background: #4CAF50 !important;
    animation: pulse 2s infinite;
}
</style>
        <script src="/config.js"></script>
        <script>

            // ============================================
            // VARI√ÅVEIS GLOBAIS DO SORTEIO AUTOM√ÅTICO
            // ============================================
            let sorteioAutomaticoAtivo = false;
            let intervalVerificacao = null;
            let roletaWindow = null;

            // ============================================
            // SISTEMA DE NOTIFICA√á√ïES
            // ============================================
            function mostrarNotificacao(mensagem, tipo = 'info') {
                console.log(`üì¢ [${tipo.toUpperCase()}] ${mensagem}`);
                
                // Criar elemento de notifica√ß√£o
                const notif = document.createElement('div');
                notif.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    font-size: 14px;
                    z-index: 9999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                    max-width: 400px;
                `;
                
                // Definir cor baseada no tipo
                if (tipo === 'success') {
                    notif.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                    notif.innerHTML = '‚úÖ ' + mensagem;
                } else if (tipo === 'error') {
                    notif.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                    notif.innerHTML = '‚ùå ' + mensagem;
                } else if (tipo === 'warning') {
                    notif.style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
                    notif.innerHTML = '‚ö†Ô∏è ' + mensagem;
                } else {
                    notif.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
                    notif.innerHTML = '‚ÑπÔ∏è ' + mensagem;
                }
                
                document.body.appendChild(notif);
                
                // Remover ap√≥s 4 segundos
                setTimeout(() => {
                    notif.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        notif.remove();
                    }, 300);
                }, 4000);
            }

            // Adicionar CSS da anima√ß√£o
            if (!document.getElementById('notif-styles')) {
                const style = document.createElement('style');
                style.id = 'notif-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

        // ========================================
        // SISTEMA DE SORTEIO AUTOM√ÅTICO
        // ========================================

        let sorteioConfig = {
            ativo: false,
            participantes_necessarios: 10
        };

       
            // ============================================
            // FUN√á√ÉO DE SORTEIO AUTOM√ÅTICO - VERS√ÉO INFINITA
            // ============================================

            async function executarSorteioAutomatico() {
                console.log('üîÑ executarSorteioAutomatico() chamada');
                console.log('üìä Estado atual:', sorteioAutomaticoAtivo);
                
                if (!sorteioAutomaticoAtivo) {
                    // ========================================
                    // ATIVAR SORTEIO AUTOM√ÅTICO INFINITO
                    // ========================================
                    console.log('üöÄ Iniciando sorteio autom√°tico INFINITO...');
                    
                    // Validar n√∫mero de participantes
                    const input = document.getElementById('participantes-necessarios');
                    if (!input) {
                        console.error('‚ùå Campo de participantes n√£o encontrado!');
                        alert('‚ö†Ô∏è Erro: Campo de configura√ß√£o n√£o encontrado!');
                        return;
                    }
                    
                    const participantesNecessarios = parseInt(input.value);
                    
                    if (!participantesNecessarios || participantesNecessarios < 1) {
                        alert('‚ö†Ô∏è Configure o n√∫mero de participantes necess√°rios primeiro!');
                        console.error('‚ùå N√∫mero inv√°lido:', participantesNecessarios);
                        return;
                    }
                    
                    console.log('‚úÖ Participantes necess√°rios:', participantesNecessarios);
                    console.log('‚ôæÔ∏è  MODO INFINITO: Sorteios continuar√£o at√© desativar');
                    
                    // Atualizar estado
                    sorteioAutomaticoAtivo = true;
                    
                    // Atualizar bot√£o
                    atualizarBotaoSorteio(true);
                    
                    console.log('‚úÖ Sorteio autom√°tico ATIVADO!');
                    console.log('‚è±Ô∏è Verificando a cada 10 segundos...');
                    
                    // Iniciar verifica√ß√£o peri√≥dica INFINITA
                    intervalVerificacao = setInterval(async () => {
                        console.log('üîç Verificando participantes...');
                        
                        try {
                            // Buscar participantes ativos
                            const response = await fetch(CONFIG.buildURL(CONFIG.API.PARTICIPANTES_ATIVOS), {
                                method: 'GET',  
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                }
                            });
                            
                            console.log('üì° Status da resposta:', response.status);
                            
                            // Validar se a resposta √© JSON
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                console.error('‚ùå Resposta n√£o √© JSON!');
                                console.error('Content-Type recebido:', contentType);
                                
                                const texto = await response.text();
                                console.error('Resposta (primeiros 500 chars):', texto.substring(0, 500));
                                return;
                            }
                            
                            if (!response.ok) {
                                console.error('‚ùå Erro HTTP:', response.status);
                                const errorText = await response.text();
                                console.error('Erro:', errorText);
                                return;
                            }
                            
                            const data = await response.json();
                            console.log('‚úÖ Dados recebidos:', data);
                            
                            const participantesAtuais = data.participantes ? data.participantes.length : 0;
                            
                            console.log(`üìä Participantes: ${participantesAtuais}/${participantesNecessarios}`);
                            
                            // ‚úÖ VERIFICAR SE ATINGIU O N√öMERO
                            if (participantesAtuais >= participantesNecessarios) {
                                console.log('üéØ N√∫mero atingido! Enviando comando...');
                                console.log('‚ôæÔ∏è  Modo infinito ativo - continuar√° ap√≥s este sorteio');
                                
                                // Enviar comando de sorteio
                                const comandoResponse = await fetch(CONFIG.buildURL(CONFIG.API.ENVIAR_COMANDO), {
                                    method: 'POST', 
                                    headers: { 
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        tipo: 'INICIAR_SORTEIO',
                                        acao: 'sortear',
                                        participantes: data.participantes,
                                        timestamp: Date.now()
                                    })
                                });
                                
                                if (comandoResponse.ok) {
                                    const resultado = await comandoResponse.json();
                                    console.log('‚úÖ Comando enviado!', resultado);
                                    console.log('üé∞ Roleta girando...');
                                    console.log('‚ôæÔ∏è  Aguardando pr√≥ximo grupo de participantes...');
                                    
                                    // ‚ùå N√ÉO DESATIVA MAIS!
                                    // O sistema continua verificando automaticamente
                                    
                                } else {
                                    console.error('‚ùå Erro ao enviar comando:', comandoResponse.status);
                                    const errorText = await comandoResponse.text();
                                    console.error('Erro:', errorText);
                                }
                            } else {
                                console.log(`‚è≥ Aguardando... Faltam ${participantesNecessarios - participantesAtuais} participantes`);
                            }
                            
                        } catch (error) {
                            console.error('‚ùå Erro na verifica√ß√£o:', error);
                            console.error('Stack:', error.stack);
                        }
                    }, 10000); // Verificar a cada 10 segundos
                    
                } else {
                    // ========================================
                    // DESATIVAR SORTEIO AUTOM√ÅTICO
                    // ========================================
                    desativarSorteioAutomatico();
                }
            }

            // Fun√ß√£o auxiliar para desativar
            function desativarSorteioAutomatico() {
                console.log('üõë Desativando sorteio autom√°tico...');
                
                sorteioAutomaticoAtivo = false;
                
                // Parar verifica√ß√£o
                if (intervalVerificacao) {
                    clearInterval(intervalVerificacao);
                    intervalVerificacao = null;
                    console.log('‚úÖ Intervalo de verifica√ß√£o parado');
                }
                
                // Atualizar bot√£o
                atualizarBotaoSorteio(false);
                
                console.log('‚úÖ Sorteio autom√°tico DESATIVADO!');
                console.log('üìä Estado final:', sorteioAutomaticoAtivo);
            }

            // Fun√ß√£o auxiliar para atualizar o bot√£o
            function atualizarBotaoSorteio(ativo) {
                try {
                    let btnSorteio = document.getElementById('btn-sorteio-automatico');
                    
                    if (!btnSorteio) {
                        const botoes = document.querySelectorAll('button');
                        btnSorteio = Array.from(botoes).find(btn => 
                            btn.getAttribute('onclick') && 
                            btn.getAttribute('onclick').includes('executarSorteioAutomatico')
                        );
                    }
                    
                    if (!btnSorteio) {
                        const botoes = document.querySelectorAll('button');
                        btnSorteio = Array.from(botoes).find(btn => 
                            btn.textContent.includes('SORTEIO AUTOM√ÅTICO')
                        );
                    }
                    
                    if (btnSorteio) {
                        if (ativo) {
                            btnSorteio.style.background = '#ff4444';
                            btnSorteio.innerHTML = 'üõë DESATIVAR SORTEIO AUTOM√ÅTICO';
                            console.log('‚úÖ Bot√£o: DESATIVAR (vermelho)');
                        } else {
                            btnSorteio.style.background = '#4CAF50';
                            btnSorteio.innerHTML = '‚úÖ ATIVAR SORTEIO AUTOM√ÅTICO';
                            console.log('‚úÖ Bot√£o: ATIVAR (verde)');
                        }
                    } else {
                        console.error('‚ùå Bot√£o n√£o encontrado!');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar bot√£o:', error);
                }
            }

            // ============================================ 
            // DISPARAR SORTEIO NAS ROLETAS ABERTAS
            // ============================================
            function abrirRoleta() {
                console.log('üé∞ Disparando comando de sorteio para todas as roletas abertas...');
                
                // Enviar comando via localStorage para todas as abas escutarem
                const comandoSorteio = {
                    acao: 'INICIAR_SORTEIO',
                    timestamp: Date.now()
                };
                
                localStorage.setItem('comando_sorteio', JSON.stringify(comandoSorteio));
                
                // Remover o comando ap√≥s 1 segundo (para permitir novos sorteios)
                setTimeout(() => {
                    localStorage.removeItem('comando_sorteio');
                }, 1000);
                
                mostrarNotificacao('üé∞ Comando de sorteio enviado para todas as roletas!', 'success');
                console.log('‚úÖ Comando enviado:', comandoSorteio);
            }

            // Mostrar sorteio na roleta
            function mostrarSorteioNaRoleta(sorteio) {
                // Se existe um iframe da roleta, envia mensagem para animar
                const iframeRoleta = document.querySelector('iframe[src*="testeroleta"]');
                if (iframeRoleta && iframeRoleta.contentWindow) {
                    iframeRoleta.contentWindow.postMessage({
                        action: 'girarAutomatico',
                        ganhador: sorteio.participante,
                        premio: sorteio.premio
                    }, '*');
                }
            }

            // Inicializar ao carregar a p√°gina
            document.addEventListener('DOMContentLoaded', () => {
                carregarConfigSorteio();
            });

                    let participantes = [];
                    let premios = [];

                    // Carregar todos os dados
                    async function recarregarDados() {
                        await Promise.all([
                            carregarParticipantes(),
                            carregarPremios()
                        ]);
                        atualizarStats();
                    }


        // Carregar participantes
            function carregarParticipantes() {
                CONFIG.fetch(CONFIG.API.PARTICIPANTES)
                    .then(data => {
                        participantes = data || [];
                        renderizarParticipantes();
                        atualizarStats();
                    })
                    .catch(erro => {
                        console.error('Erro ao carregar participantes:', erro);
                    });
            }

            // Deletar participante
            function deletarParticipante(id) {
                if (!confirm('Deseja realmente excluir este participante?')) return;
                
                CONFIG.fetch(`${CONFIG.API.PARTICIPANTES}/${id}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('Participante exclu√≠do!');
                            carregarParticipantes();
                        }
                    })
                    .catch(erro => {
                        console.error('Erro ao excluir:', erro);
                        alert('Erro ao excluir participante');
                    });
            }

            // Renderizar participantes
function renderizarParticipantes() {
    const tbody = document.getElementById('tabela-participantes');
    
    if (!participantes || participantes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum participante cadastrado</td></tr>';
        return;
    }

    tbody.innerHTML = participantes.map(p => {
        // üîç Buscar data em todos os campos poss√≠veis
        const dataRaw = p.data_cadastro || p.created_at || p.createdAt || p.dataCadastro || p.timestamp || p.date;
        
        console.log('üìÖ Data para', p.nome, ':', dataRaw);
        
        // ‚úÖ Formatar a data
        let dataFormatada = '-';
        if (dataRaw) {
            try {
                const data = new Date(dataRaw);
                
                // Verificar se √© uma data v√°lida
                if (!isNaN(data.getTime())) {
                    // üîß Ajustar para hor√°rio de Bras√≠lia (subtrair 3 horas)
                    data.setHours(data.getHours() - 3);
                    
                    const dia = String(data.getDate()).padStart(2, '0');
                    const mes = String(data.getMonth() + 1).padStart(2, '0');
                    const ano = data.getFullYear();
                    const hora = String(data.getHours()).padStart(2, '0');
                    const minuto = String(data.getMinutes()).padStart(2, '0');
                    
                    dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}`;
                } else {
                    console.warn('‚ö†Ô∏è Data inv√°lida para:', p.nome);
                }
            } catch (error) {
                console.error('‚ùå Erro ao formatar data:', error, dataRaw);
            }
        }
        
        return `
            <tr>
                <td>${p.nome}</td>
                <td>${formatarTelefone(p.whatsapp)}</td>
                <td>${p.email}</td>
                <td>${dataFormatada}</td>
                <td>
                    <button class="btn btn-danger btn-small" onclick="excluirParticipante(${p.id || p._id})">
                        üóëÔ∏è Excluir
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log(`‚úÖ ${participantes.length} participantes renderizados com data`);
}
            

            // Carregar pr√™mios
            function carregarPremios() {
                console.log('üîÑ Carregando pr√™mios...');
                
                CONFIG.fetch(CONFIG.API.PREMIOS)
                    .then(data => {
                        console.log('üì¶ Pr√™mios carregados:', data);
                        premios = data || [];
                    })
                    .then(data => {
                        console.log('üì¶ Pr√™mios carregados:', data);
                        premios = data || [];
                        renderizarPremios();
                        atualizarStats();
                    })
                    .catch(erro => {
                        console.error('‚ùå Erro ao carregar pr√™mios:', erro);
                        const tbody = document.querySelector('#premiosTable tbody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">Erro ao carregar pr√™mios</td></tr>';
                        }
                    });
            }

            function renderizarPremios() {
                console.log('üé® Renderizando pr√™mios...', premios);
                
                const tbody = document.querySelector('#premiosTable tbody');
                if (!tbody) {
                    console.error('‚ùå Tabela de pr√™mios n√£o encontrada!');
                    return;
                }

                if (!premios || premios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Nenhum pr√™mio cadastrado</td></tr>';
                    return;
                }

                const tipoIcons = {
                    'roleta': 'üé°',
                    'raspadinha': 'üé∞',
                    'ambos': 'üéØ'
                };

                const tipoColors = {
                    'roleta': '#3b82f6',
                    'raspadinha': '#8b5cf6',
                    'ambos': '#10b981'
                };

                const tipoLabels = {
                    'roleta': 'Roleta',
                    'raspadinha': 'Raspadinha',
                    'ambos': 'Ambos'
                };

                tbody.innerHTML = premios.map(premio => {
                    const tipo = premio.tipo || 'ambos';
                    return `
                        <tr>
                            <td>${premio.icone || 'üéÅ'}</td>
                            <td>${premio.nome}</td>
                            <td>${premio.descricao || '-'}</td>
                            <td>
                                <span style="background-color: ${tipoColors[tipo]}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                    ${tipoIcons[tipo]} ${tipoLabels[tipo]}
                                </span>
                            </td>
                            <td>${premio.probabilidade || 20}%</td>
                            <td>
                                <span class="status-badge ${premio.ativo ? 'status-ativo' : 'status-inativo'}">
                                    ${premio.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                                </span>
                            </td>
                            <td>
                                <button onclick="abrirEditarPremio(${premio.id})" class="btn btn-primary btn-small" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="excluirPremio(${premio.id})" class="btn btn-danger btn-small" title="Excluir">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('‚úÖ Pr√™mios renderizados com sucesso!');
            }
        

        // Atualizar estat√≠sticas
        function atualizarStats() {
            document.getElementById('total-participantes').textContent = participantes.length;
            document.getElementById('total-premios').textContent = premios.length;
            document.getElementById('premios-ativos').textContent = premios.filter(p => p.ativo).length;
        }

        // Salvar novo pr√™mio
        async function salvarPremio(event) {
            event.preventDefault();
            
            const nome = document.getElementById('input-nome-premio').value.trim();
            const tipo = document.getElementById('input-tipo-premio').value;
            const ativo = document.getElementById('input-ativo-premio').checked;

            console.log('üìù Dados do formul√°rio:', { nome, tipo, ativo });

            // Valida√ß√£o
            if (!nome) {
                alert('‚ö†Ô∏è Por favor, digite o nome do pr√™mio!');
                return;
            }

            if (!tipo) {
                alert('‚ö†Ô∏è Por favor, selecione o tipo do pr√™mio!');
                return;
            }

            const dados = {
                nome: nome,
                descricao: '',
                icone: 'üéÅ',
                tipo: tipo,
                probabilidade: 20,
                ativo: ativo
            };

            console.log('üì§ Enviando para API:', dados);

            try {
                const response = await fetch(CONFIG.buildURL(CONFIG.API.PREMIOS), {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                console.log('üì° Status HTTP:', response.status);
                console.log('üì° Content-Type:', response.headers.get('content-type'));

                // Verificar se a resposta √© JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textoErro = await response.text();
                    console.error('‚ùå Resposta n√£o √© JSON:', textoErro);
                    throw new Error('Servidor retornou HTML em vez de JSON');
                }

                const data = await response.json();
                console.log('‚úÖ Resposta da API:', data);

                if (response.ok && (data.success || data.id)) {
                    alert('‚úÖ Pr√™mio cadastrado com sucesso!');
                    fecharModal('modal-novo-premio');
                    
                    // Limpar formul√°rio
                    document.getElementById('input-nome-premio').value = '';
                    document.getElementById('input-tipo-premio').value = '';
                    document.getElementById('input-ativo-premio').checked = true;
                    
                    // Recarregar lista
                    await carregarPremios();
                } else {
                    throw new Error(data.erro || 'Erro ao cadastrar pr√™mio');
                }
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                alert('‚ùå Erro ao cadastrar pr√™mio: ' + error.message);
            }
        }

        // Abrir modal de edi√ß√£o
        function abrirEditarPremio(id) {
            console.log('üîç Tentando editar pr√™mio ID:', id);
            console.log('üì¶ Pr√™mios dispon√≠veis:', premios);
            
            // Buscar o pr√™mio (aceita tanto p.id quanto p._id)
            const premio = premios.find(p => p.id == id || p._id == id);
            
            if (!premio) {
                console.error('‚ùå Pr√™mio n√£o encontrado!');
                alert('‚ùå Erro: Pr√™mio n√£o encontrado!');
                return;
            }

            console.log('‚úÖ Pr√™mio encontrado:', premio);

            // Preencher o formul√°rio
            document.getElementById('edit-premio-id').value = id;
            document.getElementById('edit-nome-premio').value = premio.nome;
            document.getElementById('edit-tipo-premio').value = premio.tipo || 'ambos';
            document.getElementById('edit-ativo-premio').checked = premio.ativo;
            
            // Abrir o modal
            abrirModal('modal-editar-premio');
        }

        // Atualizar pr√™mio
        async function atualizarPremio(event) {
            event.preventDefault();
            
            const id = document.getElementById('edit-premio-id').value;
            const nome = document.getElementById('edit-nome-premio').value;
            const tipo = document.getElementById('edit-tipo-premio').value;
            const ativo = document.getElementById('edit-ativo-premio').checked;

            // Valida√ß√£o do tipo
            if (!tipo) {
                alert('‚ö†Ô∏è Por favor, selecione o tipo do pr√™mio!');
                return;
            }

            try {
                const response = await fetch(CONFIG.buildURL(`${CONFIG.API.PREMIOS}/${id}`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, tipo, ativo })
                });

                if (response.ok) {
                    alert('‚úÖ Pr√™mio atualizado com sucesso!');
                    fecharModal('modal-editar-premio');
                    await recarregarDados();
                } else {
                    const erro = await response.json();
                    alert('‚ùå Erro: ' + erro.erro);
                }
            } catch (error) {
                console.error('Erro:', error);
                // Fallback: atualizar localmente
                const index = premios.findIndex(p => (p.id == id || p._id == id));
                if (index !== -1) {
                    premios[index] = { ...premios[index], nome, tipo, ativo };
                    renderizarPremios();
                    alert('‚úÖ Pr√™mio atualizado localmente!');
                } else {
                    alert('‚ùå Erro ao atualizar pr√™mio');
                }
                fecharModal('modal-editar-premio');
            }
        }

        // Toggle status do pr√™mio
        async function togglePremio(id, ativo) {
            try {
                const response = await fetch(CONFIG.buildURL(`${CONFIG.API.PREMIOS}/${id}`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ativo })
                });

                if (!response.ok) {
                    // Fallback: atualizar localmente
                    const index = premios.findIndex(p => p.id === id);
                    if (index !== -1) {
                        premios[index].ativo = ativo;
                    }
                }

                await recarregarDados();
            } catch (error) {
                console.error('Erro:', error);
                await recarregarDados();
            }
        }

        // Excluir pr√™mio
        async function excluirPremio(id) {
            if (!confirm('Tem certeza que deseja excluir este pr√™mio?')) return;

            try {
                const response = await fetch(CONFIG.buildURL(`${CONFIG.API.PREMIOS}/${id}`), {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    // Fallback: excluir localmente
                    premios = premios.filter(p => p.id !== id);
                }

                await recarregarDados();
                alert('‚úÖ Pr√™mio exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao excluir pr√™mio');
            }
        }

        // Excluir participante
        async function excluirParticipante(id) {
            if (!confirm('Tem certeza que deseja excluir este participante?')) return;

            try {
                const response = await fetch(CONFIG.buildURL(`${CONFIG.API.PARTICIPANTES}/${id}`), {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Erro ao excluir');

                await recarregarDados();
                alert('‚úÖ Participante exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao excluir participante');
            }
        }

        // Modais
        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Formata√ß√£o
        function formatarTelefone(tel) {
            if (!tel) return '-';
            const cleaned = tel.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            return tel;
        }

        // ============================================
        // FUN√á√ïES DE FORMATA√á√ÉO (COPIADAS DO historico.html)
        // ============================================
        function formatarData(dataISO) {
            if (!dataISO) return '-';
            
            try {
                // Criar objeto Date a partir da string
                const data = new Date(dataISO);
                
                // Verificar se √© uma data v√°lida
                if (isNaN(data.getTime())) {
                    // Se falhar, tentar extrair manualmente
                    const partes = dataISO.replace('T', ' ').replace('Z', '').split(' ');
                    if (partes.length < 2) {
                        const [ano, mes, dia] = partes[0].split('-');
                        return `${dia}/${mes}/${ano} --:--:--`;
                    }
                    const [ano, mes, dia] = partes[0].split('-');
                    const [hora, minuto, segundo] = partes[1].split(':');
                    return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo || '00'}`;
                }
                
                // üîß SUBTRAIR 3 HORAS para ajustar ao hor√°rio de Bras√≠lia
                data.setHours(data.getHours() - 3);f
                
                // Extrair componentes da data ajustada
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                const hora = String(data.getHours()).padStart(2, '0');
                const minuto = String(data.getMinutes()).padStart(2, '0');
                const segundo = String(data.getSeconds()).padStart(2, '0');
                
                return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
            } catch (error) {
                console.error('‚ùå Erro ao formatar data:', error, dataISO);
                return '-';
            }
        }

        function formatarHora(dataISO) {
            if (!dataISO) return '--:--';
            
            try {
                // Criar objeto Date
                const data = new Date(dataISO);
                
                // üîß SUBTRAIR 3 HORAS (ajuste para Bras√≠lia)
                data.setHours(data.getHours() - 3);
                
                // Extrair hora e minuto j√° ajustados
                const hora = String(data.getHours()).padStart(2, '0');
                const minuto = String(data.getMinutes()).padStart(2, '0');
                
                return `${hora}:${minuto}`;
            } catch (error) {
                console.error('‚ùå Erro ao formatar hora:', error, dataISO);
                return '--:--';
            }
        }

        // ============================================
        // SISTEMA DE ABAS
        // ============================================
        function mudarAba(aba) {
            console.log('üîÑ Mudando para aba:', aba);
            
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#2c3e50';
            });
            
            // Mostrar aba selecionada e ativar bot√£o
            if (aba === 'participantes') {
                const abaParticipantes = document.getElementById('aba-participantes');
                if (abaParticipantes) {
                    abaParticipantes.style.display = 'block';
                }
                
                // Encontrar e ativar o bot√£o correto
                const botoes = document.querySelectorAll('.tab-button');
                if (botoes[0]) {
                    botoes[0].style.background = '#3498db';
                    botoes[0].style.color = 'white';
                }
                
                carregarParticipantes();
                
            } else if (aba === 'premios') {
                const abaPremios = document.getElementById('aba-premios');
                if (abaPremios) {
                    abaPremios.style.display = 'block';
                }
                
                const botoes = document.querySelectorAll('.tab-button');
                if (botoes[1]) {
                    botoes[1].style.background = '#3498db';
                    botoes[1].style.color = 'white';
                }
                
                carregarPremios();
                
            } else if (aba === 'sorteios') {
                const abaSorteios = document.getElementById('aba-sorteios');
                if (abaSorteios) {
                    abaSorteios.style.display = 'block';
                }
                
                const botoes = document.querySelectorAll('.tab-button');
                if (botoes[2]) {
                    botoes[2].style.background = '#3498db';
                    botoes[2].style.color = 'white';
                }
                
                carregarSorteiosAgendados();
                
            } else if (aba === 'raspadinha') {
                const abaRaspadinha = document.getElementById('aba-raspadinha');
                if (abaRaspadinha) {
                    abaRaspadinha.style.display = 'block';
                }
                
                const botoes = document.querySelectorAll('.tab-button');
                if (botoes[3]) {
                    botoes[3].style.background = '#3498db';
                    botoes[3].style.color = 'white';
                }
                
                carregarRaspadinhasAgendadas();
            }
            
            console.log('‚úÖ Aba mudada para:', aba);
        }

        // ============================================
        // SORTEIOS AGENDADOS
        // ============================================
        let premiosDisponiveis = [];
        let contadorHorarios = 0;
        let sorteiosAgendados = [];

        // Carregar sorteios agendados
        async function carregarSorteiosAgendados() {
            console.log('üîÑ Carregando sorteios agendados...');
            
            try {
                const response = await fetch(CONFIG.buildURL(CONFIG.API.SORTEIOS_AGENDADOS));
                console.log('üì° Status da resposta:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos:', data);
                
                // Garantir que sempre seja um array
                if (Array.isArray(data)) {
                    sorteiosAgendados = data;
                } else if (data.sorteios && Array.isArray(data.sorteios)) {
                    sorteiosAgendados = data.sorteios;
                } else {
                    console.error('‚ùå Formato inesperado de dados:', data);
                    sorteiosAgendados = [];
                }
                
                console.log('üìã Total de sorteios carregados:', sorteiosAgendados.length);
                
                renderizarSorteiosAgendados();
            } catch (error) {
                console.error('‚ùå Erro ao carregar sorteios:', error);
                document.getElementById('tabela-sorteios-agendados').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:#e74c3c;">Erro ao carregar sorteios: ' + error.message + '</td></tr>';
            }
        }

        // Renderizar sorteios
        function renderizarSorteiosAgendados() {
            console.log('üé® Renderizando sorteios agendados...');
            console.log('üìã Total de sorteios:', sorteiosAgendados.length);
            
            const tbody = document.getElementById('tabela-sorteios-agendados');
            
            if (!tbody) {
                console.error('‚ùå Elemento tabela-sorteios-agendados n√£o encontrado!');
                return;
            }
            
            if (sorteiosAgendados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhum sorteio agendado</td></tr>';
                console.log('‚ö†Ô∏è Nenhum sorteio para renderizar');
                return;
            }
            
            const agora = new Date();
            
            const dataHojeBR = agora.toLocaleString('pt-BR', { 
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).split('/').reverse().join('-');
            
            const horaAtualBR = agora.toLocaleString('pt-BR', { 
                timeZone: 'America/Sao_Paulo',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            console.log('üìÖ Data/Hora atual (BR):', { dataHojeBR, horaAtualBR });
            
            const html = sorteiosAgendados.map((s, index) => {
                console.log(`  Sorteio #${index + 1}:`, s);
                
                const dataSorteioObj = new Date(s.data_sorteio + 'T00:00:00-03:00');
                const data = dataSorteioObj.toLocaleDateString('pt-BR', { 
                    timeZone: 'America/Sao_Paulo',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                let premios = [];
                try {
                    premios = JSON.parse(s.premios_distribuicao || '[]');
                } catch (e) {
                    console.error(`Erro ao fazer parse dos pr√™mios do sorteio ${s.id}:`, e);
                }
                
                const sorteioDataISO = s.data_sorteio;
                const estaNoHorario = (
                    sorteioDataISO === dataHojeBR && 
                    horaAtualBR >= s.hora_inicio_sorteio && 
                    horaAtualBR <= s.hora_fim_sorteio
                );
                
                console.log(`    üìä Sorteio ${s.id}:`, {
                    data_sorteio: sorteioDataISO,
                    data_hoje: dataHojeBR,
                    hora_inicio: s.hora_inicio_sorteio,
                    hora_fim: s.hora_fim_sorteio,
                    hora_atual: horaAtualBR,
                    esta_no_horario: estaNoHorario
                });
                
                let statusHTML = '';
                if (s.status === 'pendente') {
                    if (estaNoHorario) {
                        statusHTML = '<span style="background:#dbeafe;color:#1e40af;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üîµ ATIVO AGORA</span>';
                    } else {
                        statusHTML = '<span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚è≥ Pendente</span>';
                    }
                } else if (s.status === 'executado') {
                    statusHTML = '<span style="background:#d1fae5;color:#065f46;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚úÖ Executado</span>';
                } else {
                    statusHTML = '<span style="background:#fee2e2;color:#991b1b;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚ùå Cancelado</span>';
                }
                
                let premiosHTML;
                if (estaNoHorario && premios.length > 0) {
                    const premiosAtivos = premios.filter(p => {
                        return p.horario_inicio <= horaAtualBR && p.horario_fim >= horaAtualBR;
                    });
                    
                    if (premiosAtivos.length > 0) {
                        premiosHTML = premiosAtivos.map(p => 
                            `üéÅ <strong>${p.premio_nome}</strong> <span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:8px;font-size:11px;">üîµ ATIVO</span>`
                        ).join('<br>');
                    } else {
                        premiosHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Nenhum pr√™mio ativo neste hor√°rio</span>';
                    }
                } else if (premios.length > 0) {
                    premiosHTML = premios.map(p => 
                        `üéÅ ${p.premio_nome}`
                    ).join('<br>');
                } else {
                    premiosHTML = '<span style="color:#999;">Nenhum pr√™mio configurado</span>';
                }
                
                const horariosHTML = premios.length > 0 
                    ? premios.map(p => `‚è∞ ${p.horario_inicio} - ${p.horario_fim}`).join('<br>')
                    : '-';
                
                return `
                    <tr style="${estaNoHorario ? 'background:#f0f9ff;border-left:4px solid #1e40af;' : ''}">
                        <td>#${s.id}</td>
                        <td>
                            üìÖ ${data}<br>
                            üïê ${s.hora_inicio_sorteio} at√© ${s.hora_fim_sorteio}
                            ${estaNoHorario ? '<br><span style="color:#1e40af;font-weight:700;font-size:13px;">üîµ EM ANDAMENTO</span>' : ''}
                        </td>
                        <td>${premiosHTML}</td>
                        <td>${horariosHTML}</td>
                        <td>${statusHTML}</td>
                        <td>
                            ${s.status === 'pendente' ? `
                                <button class="btn btn-danger btn-small" onclick="cancelarSorteio(${s.id})">
                                    üóëÔ∏è Cancelar
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
            console.log('‚úÖ Sorteios renderizados com sucesso!');
        }

                   // Abrir modal de novo sorteiov
        async function abrirModalNovoSorteio() {
            try {
                // Carregar pr√™mios ATIVOS da API
                const response = await fetch(CONFIG.buildURL(CONFIG.API.PREMIOS_ATIVOS));
                const data = await response.json();
                const todosPremios = data.premios || [];
                
                // ‚≠ê FILTRAR apenas pr√™mios de ROLETA (tipo = 'roleta' ou 'ambos')
                premiosDisponiveis = todosPremios.filter(p => 
                    p.tipo === 'roleta' || p.tipo === 'ambos'
                );
                
                console.log('‚úÖ Pr√™mios de ROLETA carregados:', premiosDisponiveis);
                
                if (premiosDisponiveis.length === 0) {
                    alert('‚ö†Ô∏è Nenhum pr√™mio de roleta cadastrado! Cadastre pr√™mios do tipo "Roleta" ou "Ambos" primeiro.');
                    return;
                }
                
                // Mostrar pr√™mios dispon√≠veis no card informativo
                const div = document.getElementById('premiosDisponiveis');
                div.innerHTML = premiosDisponiveis.map(p => 
                    `<span style="display:inline-block;background:#e3f2fd;color:#1976d2;padding:4px 10px;border-radius:8px;margin:3px;">üé° ${p.nome}</span>`
                ).join('');
                
                // Limpar formul√°rio
                document.getElementById('dataSorteio').value = '';
                document.getElementById('horaInicioSorteio').value = '';
                document.getElementById('horaFimSorteio').value = '';
                
                // Limpar e adicionar primeiro hor√°rio
                document.getElementById('listaHorariosPremios').innerHTML = '';
                contadorHorarios = 0;
                adicionarHorarioPremio();
                
                // Abrir modal
                abrirModal('modal-novo-sorteio');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar pr√™mios:', error);
                alert('‚ùå Erro ao carregar pr√™mios. Verifique se h√° pr√™mios cadastrados.');
            }
        }

        // Adicionar hor√°rio de pr√™mio
        function adicionarHorarioPremio() {
            // ... resto do c√≥digo ...

            const id = contadorHorarios++;
            const container = document.getElementById('listaHorariosPremios');
            
            const div = document.createElement('div');
            div.id = `horario-${id}`;
            div.style.cssText = 'border: 2px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: white;';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>Hor√°rio #${id + 1}</strong>
                    <button type="button" class="btn btn-danger btn-small" onclick="removerHorarioPremio(${id})">
                        üóëÔ∏è
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Hora In√≠cio:</label>
                        <input type="time" id="horaInicio-${id}" required style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Hora Fim:</label>
                        <input type="time" id="horaFim-${id}" required style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Pr√™mio:</label>
                        <select id="premio-${id}" required style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="">Selecione...</option>
                            ${premiosDisponiveis.map(p => `<option value="${p.id}">üé° ${p.nome}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
        }

        // Remover hor√°rio
        function removerHorarioPremio(id) {
            document.getElementById(`horario-${id}`)?.remove();
        }

        // Salvar sorteio agendado
            async function salvarSorteioAgendado(event) {
                event.preventDefault();
                
                console.log('üíæ Iniciando salvamento de sorteio...');
                
                const dataSorteio = document.getElementById('dataSorteio').value;
                const horaInicioSorteio = document.getElementById('horaInicioSorteio').value;
                const horaFimSorteio = document.getElementById('horaFimSorteio').value;
                
                console.log('üìÖ Dados do sorteio:', { dataSorteio, horaInicioSorteio, horaFimSorteio });
                
                if (!dataSorteio || !horaInicioSorteio || !horaFimSorteio) {
                    alert('‚ùå Preencha data, hora de in√≠cio e hora de fim do sorteio!');
                    return;
                }
                
                // Validar se hora fim √© maior que hora in√≠cio
                if (horaFimSorteio <= horaInicioSorteio) {
                    alert('‚ùå A hora de fim deve ser maior que a hora de in√≠cio!');
                    return;
                }
                
                // Coletar hor√°rios
                const premiosDistribuicao = [];
                const container = document.getElementById('listaHorariosPremios');
                const horarios = container.querySelectorAll('[id^="horario-"]');
                
                console.log('üîç Total de hor√°rios encontrados:', horarios.length);
                
                for (const horario of horarios) {
                    const id = horario.id.split('-')[1];
                    const horaInicio = document.getElementById(`horaInicio-${id}`)?.value;
                    const horaFim = document.getElementById(`horaFim-${id}`)?.value;
                    const premioId = document.getElementById(`premio-${id}`)?.value;
                    
                    console.log(`  Hor√°rio #${id}:`, { horaInicio, horaFim, premioId });
                    
                    if (!horaInicio || !horaFim || !premioId) {
                        alert('‚ùå Preencha todos os campos dos hor√°rios de pr√™mios!');
                        return;
                    }

                    // Validar se os hor√°rios dos pr√™mios est√£o dentro do per√≠odo do sorteio
                    if (horaInicio < horaInicioSorteio || horaFim > horaFimSorteio) {
                        alert(`‚ùå Os hor√°rios dos pr√™mios devem estar entre ${horaInicioSorteio} e ${horaFimSorteio}!`);
                        return;
                    }
                    
                    const premio = premiosDisponiveis.find(p => p.id == premioId);
                    
                    if (!premio) {
                        alert(`‚ùå Pr√™mio n√£o encontrado: ID ${premioId}`);
                        return;
                    }
                    
                    premiosDistribuicao.push({
                        horario_inicio: horaInicio,
                        horario_fim: horaFim,
                        premio_id: premioId,
                        premio_nome: premio.nome
                    });
                }
                
                if (premiosDistribuicao.length === 0) {
                    alert('‚ùå Adicione pelo menos um hor√°rio de pr√™mio!');
                    return;
                }
                
                console.log('üì¶ Pr√™mios a enviar:', premiosDistribuicao);
                
                try {
                    const payload = {
                        data_sorteio: dataSorteio,
                        hora_inicio_sorteio: horaInicioSorteio,
                        hora_fim_sorteio: horaFimSorteio,
                        premios_distribuicao: premiosDistribuicao
                    };
                    
                    console.log('üì§ Enviando para API:', payload);
                    
                    const response = await fetch(CONFIG.buildURL(CONFIG.API.SORTEIOS_AGENDADOS), {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('üì° Status da resposta:', response.status);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.erro || 'Erro ao agendar sorteio');
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ Resposta da API:', data);
                    
                    alert('‚úÖ Sorteio agendado com sucesso!');
                    fecharModal('modal-novo-sorteio');
                    await carregarSorteiosAgendados();
                    
                } catch (error) {
                    console.error('‚ùå Erro completo:', error);
                    alert('‚ùå Erro ao salvar sorteio: ' + error.message);
                }
            }

        // Cancelar sorteio
        async function cancelarSorteio(id) {
            if (!confirm('‚ùå Cancelar este sorteio?')) return;
            
            try {
                const response = await fetch(CONFIG.buildURL(`${CONFIG.API.SORTEIOS_AGENDADOS}/${id}`), {
                    method: 'PUT',  
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'cancelado' })
                });
                
                if (response.ok) {
                    alert('‚úÖ Sorteio cancelado!');
                    await carregarSorteiosAgendados();
                }
            } catch (error) {
                alert('‚ùå Erro ao cancelar');
            }
        }

        // Filtrar sorteios
        function filtrarSorteiosAgendados() {
            renderizarSorteiosAgendados();
        }

        // Inicializar
        recarregarDados();

        // ============================================
        // GERENCIAMENTO DE RASPADINHAS AGENDADAS
        // ============================================

        let raspadinhasAgendadas = [];
        let premiosRaspadinha = [];
        let contadorHorariosRaspadinha = 0;

        // Carregar raspadinhas agendadas
        async function carregarRaspadinhasAgendadas() {
            try {
                const response = await fetch(CONFIG.buildURL(CONFIG.API.RASPADINHAS_AGENDADAS));
                const data = await response.json();
                raspadinhasAgendadas = Array.isArray(data) ? data : data.raspadinhas || [];
                
                renderizarRaspadinhasAgendadas();
            } catch (error) {
                console.error('Erro ao carregar raspadinhas:', error);
                document.getElementById('tabela-raspadinhas-agendadas').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:#e74c3c;">Erro ao carregar raspadinhas</td></tr>';
            }
        }

        // Renderizar raspadinhas
        function renderizarRaspadinhasAgendadas() {
            const tbody = document.getElementById('tabela-raspadinhas-agendadas');
            
            if (raspadinhasAgendadas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhuma raspadinha agendada</td></tr>';
                return;
            }
            
            const agora = new Date();
            const dataHojeBR = agora.toLocaleString('pt-BR', { 
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).split('/').reverse().join('-');
            
            const horaAtualBR = agora.toLocaleString('pt-BR', { 
                timeZone: 'America/Sao_Paulo',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            tbody.innerHTML = raspadinhasAgendadas.map(r => {
                const dataObj = new Date(r.data_raspadinha + 'T00:00:00-03:00');
                const data = dataObj.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
                const premios = JSON.parse(r.premios_distribuicao || '[]');
                
                const raspadinhaDataISO = r.data_raspadinha;
                const estaNoHorario = (
                    raspadinhaDataISO === dataHojeBR && 
                    horaAtualBR >= r.hora_inicio && 
                    horaAtualBR <= r.hora_fim
                );
                
                let statusHTML = '';
                if (r.status === 'pendente') {
                    if (estaNoHorario) {
                        statusHTML = '<span style="background:#dbeafe;color:#1e40af;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üîµ ATIVA AGORA</span>';
                    } else {
                        statusHTML = '<span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚è≥ Pendente</span>';
                    }
                } else if (r.status === 'ativo') {
                    statusHTML = '<span style="background:#dbeafe;color:#1e40af;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üîµ Ativo</span>';
                } else if (r.status === 'realizado') {
                    statusHTML = '<span style="background:#d1fae5;color:#065f46;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚úÖ Realizado</span>';
                } else {
                    statusHTML = '<span style="background:#fee2e2;color:#991b1b;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚ùå Cancelado</span>';
                }
                
                let premiosHTML;
                if (estaNoHorario) {
                    const premiosAtivos = premios.filter(p => {
                        return p.horario_inicio <= horaAtualBR && p.horario_fim >= horaAtualBR;
                    });
                    
                    if (premiosAtivos.length > 0) {
                        premiosHTML = premiosAtivos.map(p => 
                            `<div style="margin:2px 0;">üéÅ <strong>${p.premio_nome}</strong> <span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:8px;font-size:11px;">üîµ ATIVO</span></div>`
                        ).join('');
                    } else {
                        premiosHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Nenhum pr√™mio ativo neste hor√°rio</span>';
                    }
                } else {
                    premiosHTML = premios.map(p => 
                        `<div style="margin:2px 0;">üéÅ ${p.premio_nome} (${p.horario_inicio}-${p.horario_fim})</div>`
                    ).join('');
                }
                
                return `
                    <tr style="${estaNoHorario ? 'background:#f0f9ff;border-left:4px solid #1e40af;' : ''}">
                        <td>#${r.id}</td>
                        <td>üìÖ ${data}</td>
                        <td>
                            üïê ${r.hora_inicio} at√© ${r.hora_fim}
                            ${estaNoHorario ? '<br><span style="color:#1e40af;font-weight:700;font-size:13px;">üîµ EM ANDAMENTO</span>' : ''}
                        </td>
                        <td>${premiosHTML}</td>
                        <td>${statusHTML}</td>
                        <td>
                            ${r.status === 'pendente' || r.status === 'ativo' ? `
                                <button class="btn btn-danger btn-small" onclick="cancelarRaspadinha(${r.id})">
                                    üóëÔ∏è Cancelar
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Abrir modal de nova raspadinha
        async function abrirModalNovaRaspadinha() {
            try {
                // Carregar pr√™mios de RASPADINHA (tipo = 'raspadinha' ou 'ambos')
                const response = await fetch(CONFIG.buildURL(CONFIG.API.PREMIOS_ATIVOS));
                const data = await response.json();
                const todosPremios = data.premios || [];
                
                // Filtrar apenas pr√™mios de raspadinha
                premiosRaspadinha = todosPremios.filter(p => 
                    p.tipo === 'raspadinha' || p.tipo === 'ambos'
                );
                
                console.log('‚úÖ Pr√™mios de raspadinha carregados:', premiosRaspadinha);
                
                if (premiosRaspadinha.length === 0) {
                    alert('‚ö†Ô∏è Nenhum pr√™mio de raspadinha cadastrado! Cadastre pr√™mios do tipo "Raspadinha" ou "Ambos" primeiro.');
                    return;
                }
                
                // Mostrar pr√™mios dispon√≠veis
                const div = document.getElementById('premiosDisponiveisRaspadinha');
                div.innerHTML = premiosRaspadinha.map(p => 
                    `<span style="display:inline-block;background:#fff3e0;color:#f57c00;padding:4px 10px;border-radius:8px;margin:3px;">üé∞ ${p.nome}</span>`
                ).join('');
                
                // Limpar formul√°rio
                document.getElementById('dataRaspadinha').value = '';
                document.getElementById('horaInicioRaspadinha').value = '';
                document.getElementById('horaFimRaspadinha').value = '';
                
                // Limpar e adicionar primeiro hor√°rio
                document.getElementById('listaHorariosPremiosRaspadinha').innerHTML = '';
                contadorHorariosRaspadinha = 0;
                adicionarHorarioPremioRaspadinha();
                
                // Abrir modal
                abrirModal('modal-nova-raspadinha');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar pr√™mios:', error);
                alert('‚ùå Erro ao carregar pr√™mios de raspadinha.');
            }
        }

        // Adicionar hor√°rio de pr√™mio para raspadinha
        function adicionarHorarioPremioRaspadinha() {
            const id = contadorHorariosRaspadinha++;
            const container = document.getElementById('listaHorariosPremiosRaspadinha');
            
            const div = document.createElement('div');
            div.id = `horarioRaspadinha-${id}`;
            div.style.cssText = 'border: 2px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: white;';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>Hor√°rio #${id + 1}</strong>
                    <button type="button" class="btn btn-danger btn-small" onclick="removerHorarioPremioRaspadinha(${id})">
                        üóëÔ∏è
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Hora In√≠cio:</label>
                        <input type="time" id="horaInicioRaspadinha-${id}" required style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Hora Fim:</label>
                        <input type="time" id="horaFimRaspadinha-${id}" required style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Pr√™mio:</label>
                        <select id="premioRaspadinha-${id}" required style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="">Selecione...</option>
                            ${premiosRaspadinha.map(p => `<option value="${p.id}">üé∞ ${p.nome}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
        }

        // Remover hor√°rio de raspadinha
        function removerHorarioPremioRaspadinha(id) {
            document.getElementById(`horarioRaspadinha-${id}`)?.remove();
        }

        // Salvar raspadinha agendada
        async function salvarRaspadinhaAgendada(event) {
            event.preventDefault();
            
            const dataRaspadinha = document.getElementById('dataRaspadinha').value;
            const horaInicioRaspadinha = document.getElementById('horaInicioRaspadinha').value;
            const horaFimRaspadinha = document.getElementById('horaFimRaspadinha').value;
            
            if (!dataRaspadinha || !horaInicioRaspadinha || !horaFimRaspadinha) {
                alert('‚ùå Preencha data, hora de in√≠cio e hora de fim!');
                return;
            }
            
            if (horaFimRaspadinha <= horaInicioRaspadinha) {
                alert('‚ùå A hora de fim deve ser maior que a hora de in√≠cio!');
                return;
            }
            
            // Coletar hor√°rios
            const premiosDistribuicao = [];
            const container = document.getElementById('listaHorariosPremiosRaspadinha');
            const horarios = container.querySelectorAll('[id^="horarioRaspadinha-"]');
            
            for (const horario of horarios) {
                const id = horario.id.split('-')[1];
                const horaInicio = document.getElementById(`horaInicioRaspadinha-${id}`)?.value;
                const horaFim = document.getElementById(`horaFimRaspadinha-${id}`)?.value;
                const premioId = document.getElementById(`premioRaspadinha-${id}`)?.value;
                
                if (!horaInicio || !horaFim || !premioId) {
                    alert('‚ùå Preencha todos os campos!');
                    return;
                }
                
                if (horaInicio < horaInicioRaspadinha || horaFim > horaFimRaspadinha) {
                    alert(`‚ùå Os hor√°rios dos pr√™mios devem estar entre ${horaInicioRaspadinha} e ${horaFimRaspadinha}!`);
                    return;
                }
                
                const premio = premiosRaspadinha.find(p => p.id == premioId);
                premiosDistribuicao.push({
                    horario_inicio: horaInicio,
                    horario_fim: horaFim,
                    premio_id: premioId,
                    premio_nome: premio.nome
                });
            }
            
            if (premiosDistribuicao.length === 0) {
                alert('‚ùå Adicione pelo menos um hor√°rio!');
                return;
            }
            
            try {
                const response = await fetch(CONFIG.buildURL(CONFIG.API.RASPADINHAS_AGENDADAS), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data_raspadinha: dataRaspadinha,
                        hora_inicio: horaInicioRaspadinha,
                        hora_fim: horaFimRaspadinha,
                        premios_distribuicao: premiosDistribuicao
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Raspadinha agendada com sucesso!');
                    fecharModal('modal-nova-raspadinha');
                    await carregarRaspadinhasAgendadas();
                } else {
                    const erro = await response.json();
                    alert('‚ùå Erro: ' + (erro.erro || 'Erro ao agendar raspadinha'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao salvar raspadinha');
            }
        }

        // Cancelar raspadinha
        async function cancelarRaspadinha(id) {
            if (!confirm('‚ùå Cancelar esta raspadinha?')) return;
            
            try {
                const response = await fetch(CONFIG.buildURL(`${CONFIG.API.RASPADINHAS_AGENDADAS}/${id}`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'cancelado' })
                });
                
                if (response.ok) {
                    alert('‚úÖ Raspadinha cancelada!');
                    await carregarRaspadinhasAgendadas();
                } else {
                    alert('‚ùå Erro ao cancelar raspadinha');
                }
            } catch (error) {
                alert('‚ùå Erro ao cancelar');
            }
        }

        // Filtrar raspadinhas
        function filtrarRaspadinhasAgendadas() {
            // Implementar filtros se necess√°rio
            renderizarRaspadinhasAgendadas();
        }
        

        // Carregar dados iniciais ao abrir o painel
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Painel carregado!');
            
            // Carregar aba ativa (padr√£o: participantes)
            mudarAba('participantes');
        });

        // ============================================
        // ATUALIZAR TABELAS A CADA MINUTO
        // ============================================
        setInterval(() => {
            console.log('üîÑ Atualizando tabelas...');
            
            // Verificar qual aba est√° ativa
            const abaSorteios = document.getElementById('aba-sorteios');
            const abaRaspadinha = document.getElementById('aba-raspadinha');
            
            if (abaSorteios && abaSorteios.style.display !== 'none') {
                renderizarSorteiosAgendados();
            }
            
            if (abaRaspadinha && abaRaspadinha.style.display !== 'none') {
                renderizarRaspadinhasAgendadas();
            }
        }, 60000); // A cada 60 segundos


        // ============================================
        // VERIFICA√á√ÉO PERI√ìDICA DE PARTICIPANTES
        // ============================================

        let intervaloVerificacao = null;

        function iniciarVerificacaoPeriodica() {
            if (window.intervaloVerificacao) {
                clearInterval(window.intervaloVerificacao);
            }
            
            console.log('üîÑ Iniciando verifica√ß√£o peri√≥dica a cada 10 segundos...');
            
            window.intervaloVerificacao = setInterval(async () => {
                try {
                    const response = await fetch(CONFIG.buildURL(CONFIG.API.VERIFICAR_COMANDO));
                    const data = await response.json();
                    
                    console.log('üîç Verificando sorteio:', data);
                    
                    if (data.deve_sortear) {
                        console.log('üé∞ CONDI√á√ïES ATENDIDAS! Iniciando sorteio...');
                        clearInterval(window.intervaloVerificacao);
                        window.intervaloVerificacao = null;
                        
                        // Executar sorteio
                        await executarSorteioAutomatico();
                    } else {
                        console.log(`‚è≥ Aguardando... (${data.participantes_atuais || 0}/${data.participantes_necessarios || 0})`);
                        
                        // Atualizar barra de progresso SE existir
                        try {
                            const barraProgresso = document.getElementById('barra-progresso');
                            const textoProgresso = document.getElementById('texto-progresso');
                            
                            if (barraProgresso && textoProgresso) {
                                const porcentagem = Math.min(
                                    (data.participantes_atuais / data.participantes_necessarios) * 100,
                                    100
                                );
                                
                                barraProgresso.style.width = porcentagem + '%';
                                barraProgresso.textContent = Math.round(porcentagem) + '%';
                                textoProgresso.textContent = 
                                    `${data.participantes_atuais} / ${data.participantes_necessarios} participantes`;
                            }
                        } catch (uiError) {
                            // Ignorar erro de UI silenciosamente
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro na verifica√ß√£o peri√≥dica:', error);
                }
            }, 10000); // 10 segundos
        }

        // ============================================
        // RETOMAR SORTEIO AUTOM√ÅTICO AO CARREGAR
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üìÑ P√°gina carregada, verificando configura√ß√µes...');
                
                const response = await fetch(CONFIG.buildURL('/api/configuracoes'));
                
                if (!response.ok) {
                    console.log('‚ö†Ô∏è N√£o foi poss√≠vel buscar configura√ß√µes');
                    return;
                }
                
                const configs = await response.json();
                const sorteioAtivo = configs.find(c => c.chave === 'sorteio_automatico_ativo');
                
                if (sorteioAtivo && sorteioAtivo.valor === 'true') {
                    console.log('‚úÖ Sorteio autom√°tico estava ativo, retomando verifica√ß√£o...');
                    
                    const configParticipantes = configs.find(c => c.chave === 'participantes_necessarios');
                    const necessarios = configParticipantes ? configParticipantes.valor : '?';
                    
                    console.log(`   Necess√°rios: ${necessarios} participantes`);
                    
                    // Iniciar verifica√ß√£o
                    iniciarVerificacaoPeriodica();
                } else {
                    console.log('‚ÑπÔ∏è Sorteio autom√°tico est√° desativado');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar configura√ß√µes:', error);
            }
        });

        console.log('‚úÖ Fun√ß√µes de sorteio autom√°tico carregadas!');
 
    </script>
    
</body>
</html>
