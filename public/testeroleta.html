<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta de Pr√™mios</title>
    <script src="/config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
        }

        body {
           font-family: 'Montserrat', Arial, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            position: relative;
        }

        #video-fundo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }


        .main-wrapper {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .topo-imagem {
            width: 100%;
            display: block;
            margin: 0 auto;              /* ‚úÖ Centralizar */
            vertical-align: top;
            height: 180px;               /* ‚úÖ Ajuste conforme necess√°rio */
            object-fit: contain;         /* ‚úÖ IMPORTANTE: Mostra completo */
            object-position: center;     /* ‚úÖ Centraliza */
            background: transparent;     /* ‚úÖ Fundo transparente */
        }
        
        @keyframes pulsar {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        /* Responsivo para o texto sobre a imagem */
        @media (max-width: 768px) {
            .texto-sobre-imagem {
                font-size: 1.2em;
                padding: 15px 25px;
                letter-spacing: 1px;
            }
        }

        @media (max-width: 480px) {
            .texto-sobre-imagem {
                font-size: 0.9em;
                padding: 10px 20px;
                letter-spacing: 0.5px;
            }
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;  /* Mant√©m empilhado por padr√£o */
            gap: 20px;
            align-items: center;
            padding: 30px 5px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ‚úÖ NOVO: Container para Roleta + Card lado a lado */
        .roleta-e-card-wrapper {
            display: grid;
            grid-template-columns: 1fr auto;  /* 50% cada */
            gap: 10px;
            width: 100%;
            max-width: 1000px;
            align-items: start;
        }

        .container {
            width: 100%;
            max-width: 600px;  /* ‚úÖ LIMITA A LARGURA */
            text-align: center;
            margin: 0 auto;    /* ‚úÖ CENTRALIZA */
        }

        .card-premios {
            background: white;
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 100%;  /* ‚úÖ Ocupa todo espa√ßo dispon√≠vel */
            margin: 0;
            height: fit-content;  /* ‚úÖ Se ajusta ao conte√∫do */
            overflow: hidden;  /* ‚úÖ Garante que nada saia do card */
        }

        .card-premios h3 {
            color: #667eea;
            font-size: 1em;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.3;
        }

         /* ‚úÖ LISTA HORIZONTAL COM SCROLL */
        #listaPremios {
            display: flex;
            flex-direction: row;  /* Alinhamento horizontal */
            gap: 10px;
            overflow-x: auto;  /* Scroll horizontal */
            overflow-y: hidden;  /* Sem scroll vertical */
            padding: 10px 5px;
            scroll-behavior: smooth;  /* Scroll suave */
            
            /* Estiliza√ß√£o da barra de scroll */
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        /* Estiliza√ß√£o da barra de scroll para Webkit (Chrome, Safari, Edge) */
        #listaPremios::-webkit-scrollbar {
            height: 8px;
        }

        #listaPremios::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #listaPremios::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        #listaPremios::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .premio-item {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            font-size: 0.9em;
            line-height: 1.3;
            margin: 0;
            white-space: nowrap;  /* ‚úÖ Texto n√£o quebra linha */
            flex-shrink: 0;  /* ‚úÖ Itens n√£o encolhem */
            min-width: fit-content;  /* ‚úÖ Largura m√≠nima baseada no conte√∫do */
        }

        .sem-premios {
            width: 100%;  /* Ocupa toda a largura quando n√£o h√° pr√™mios */
            height: 30px;
            text-align: center;
            align-items: center;
            white-space: normal;  /* Permite quebra de linha */
        }

        .premio-item:last-child {
            margin-bottom: 0;
        }

        .card-premios .sem-premios {
            position: absolute;
            bottom: 8px;               /* dist√¢ncia do fundo do card */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            padding: 0;                /* se quiser, tira o padding */
        }

        .container {
            min-width: 0; /* Permite que o container encolha */
            gap: 300px;
        }

        .roleta-wrapper {
            width: 100%;
            margin: 0 auto 50px;
        }

        h1 {
            color: #fff !important;
            font-size: 1em !important;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: block !important;
            opacity: 1 !important;
            padding: 5px;
        }

        .premio-rotativo {
            color: #ffd700 !important;
            animation: pulsar 1s ease-in-out infinite;
            font-size: 0.9em;
            display: inline-block;
        }

        @keyframes pulsar {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .info-participantes {
            color: #fff;
            font-size: 1.1em;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
        }

        .roleta-wrapper {
            position: relative;
            width: 100%;
            max-width: 530px;
            margin: 0 auto 50px;
        }

       /* ajuste a posi√ß√£o como voc√™ j√° fazia */
        .seta-indicador{
            position:absolute;
            top:-10px;                 /* afasta da roleta */
            left:50%;
            transform:translateX(-50%) rotate(-45deg);

            width:22px;                /* cabeÔøΩa menor */
            height:22px;

            /* fumaÔøΩa suave */
            filter:
                drop-shadow(0 2px 4px rgba(0,0,0,.35))
                drop-shadow(0 10px 18px rgba(0,0,0,.18));

            z-index:9999;
            pointer-events:none;

            /* garante que os z-index internos funcionem isolados */
            isolation:isolate;
            }

            /* CONTORNO branco (fica ATRÔøΩS) */
            .seta-indicador::after{
            content:"";
            position:absolute;
            inset:-2px;                        /* controla a espessura do contorno */
            border-radius:50% 50% 50% 0;
            background:#fff;
            z-index:0;                         /* atrÔøΩs */
            }

            /* MIOLO dourado (fica NA FRENTE) */
            .seta-indicador::before{
            content:"";
            position:absolute;
            inset:0;
            border-radius:50% 50% 50% 0;
            background:#B8860B;                /* dourado */
            z-index:1;                         /* na frente */
        }




        .roleta-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            margin: 0 auto;
        }

        #roletaCanvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transition: transform 0.1s ease-out;
             border: 8px solid #B8860B;
        }

        .centro-roleta {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 5;
            pointer-events: none;
            padding: 20px;
        }

        .logo-roleta {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .mensagem-aguardando {
            text-align: center;
            font-size: 0.85em;
            font-weight: 700;
            color: #667eea;
            line-height: 1.4;
            padding: 10px;
        }

        .btn-girar {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 20px 50px;
            font-size: 1.5em;
            font-weight: 900;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #b8860b, 0 10px 20px rgba(0,0,0,0.3);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-girar:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #b8860b, 0 12px 25px rgba(0,0,0,0.4);
        }

        .btn-girar:active:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #b8860b, 0 5px 10px rgba(0,0,0,0.3);
        }

        .btn-girar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .resultado {
            display: none;
            background: #fff;
            padding: 12px 20px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
            animation: slideUp 0.5s ease-out;
            
            /* ‚úÖ POSI√á√ÉO FIXA NO RODAP√â */
            position: fixed;
            bottom: 20px;  /* ‚úÖ 20PX ACIMA DO RODAP√â */
            left: 50%;
            transform: translateX(-50%);  /* ‚úÖ CENTRALIZADO */
            
            /* ‚úÖ LARGURA */
            width: 90%;
            min-width: 150px;
            max-width: 600px;
            margin: 0;
            box-sizing: border-box;
            
            /* ‚úÖ Z-INDEX */
            z-index: 9999;
        }

        .resultado.ativo {
            display: block;
        }

        /* ‚úÖ ANIMA√á√ÉO */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ‚úÖ T√çTULO "PARAB√âNS" - MENOR */
        .resultado h2 {
            color: #667eea;
            font-size: clamp(1.2em, 4vw, 1.5em);  /* ‚úÖ REDUZIDO */
            margin-bottom: 10px;                   /* ‚úÖ REDUZIDO (era 15px) */
            text-align: center;
            font-weight: 800;
        }

        /* ‚úÖ NOME DO GANHADOR - COMPACTO */
        .resultado .ganhador {
            font-size: clamp(1em, 3.5vw, 1.4em);  /* ‚úÖ REDUZIDO */
            color: #333;
            font-weight: 900;
            margin: 10px 0;                        /* ‚úÖ REDUZIDO (era 15px) */
            text-align: center;
            
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            
            width: 100%;
            max-width: 100%;
            padding: 8px;                          /* ‚úÖ REDUZIDO (era 10px) */
            box-sizing: border-box;
            line-height: 1.2;                      /* ‚úÖ REDUZIDO (era 1.3) */
            white-space: normal;
            overflow: hidden;
            text-overflow: clip;
        }

        /* ‚úÖ CLASSE ESPECIAL PARA NOMES LONGOS */
        .resultado .ganhador.nome-extra-longo {
            font-size: clamp(0.85em, 2.8vw, 1.1em) !important;
            line-height: 1.1;
            padding: 6px;
            letter-spacing: -0.5px;
        }

        /* ‚úÖ PR√äMIO - COMPACTO */
        .resultado .premio {
            font-size: clamp(0.9em, 3vw, 1.2em);  /* ‚úÖ REDUZIDO */
            color: #fff;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 10px 15px;                    /* ‚úÖ REDUZIDO (era 15px) */
            border-radius: 8px;                    /* ‚úÖ REDUZIDO (era 10px) */
            text-align: center;
            
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            box-sizing: border-box;
        }

        .aviso {
            color: #fff;
            background: rgba(255,68,68,0.9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .loading {
            color: #fff;
            font-size: 1.2em;
            margin-top: 20px;
        }

        /* Tablets */
        @media (max-width: 1024px) {
            .content-wrapper {
                flex-direction: column;
                max-width: 600px;
                padding: 20px 15px;
                gap: 20px;
            }

            .roleta-e-card-wrapper {
                grid-template-columns: 1fr;  /* 1 coluna */
                gap: 20px;
            }

            .card-premios {
                max-width: 500px;
                margin: 0 auto;
            }

            .card-premios h3 {
                font-size: 1.1em;
            }

            .premio-item {
                padding: 10px;
                font-size: 0.85em;
            }

            h1 {
                font-size: 1em;
            }

            .roleta-wrapper {
                max-width: 400px;
                margin: 0 auto 40px;
            }

            .centro-roleta {
                width: 150px;
                height: 150px;
            }

            .mensagem-aguardando {
                font-size: 0.75em;
            }

            .resultado {
                padding: 12px 18px;
                width: 88%;
                max-width: 450px;
                padding: 10px 18px;
            }
            
            .resultado h2 {
                font-size: clamp(1.1em, 3.8vw, 1.4em);
                margin-bottom: 8px;
            }
            
            .resultado .ganhador {
                font-size: clamp(0.95em, 3.2vw, 1.3em);
                margin: 8px 0;
                padding: 7px;
            }
            
            .resultado .ganhador.nome-extra-longo {
                font-size: clamp(0.8em, 2.5vw, 1em) !important;
            }
            
            .resultado .premio {
                font-size: clamp(0.85em, 2.8vw, 1.1em);
                padding: 9px 12px;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .topo-imagem {
                max-height: 140px;
                object-fit: cover;
            }

            .roleta-e-card-wrapper {
                grid-template-columns: 1fr;
            }
            
            .card-premios {
                order: 2;  /* Card aparece depois da roleta */
            }
            
            .container {
                order: 1;  /* Roleta aparece primeiro */
            }

            .content-wrapper {
                grid-template-columns: auto 1fr;
                padding: 15px 10px;
                gap: 10px;
            }

            .card-premios {
                min-width: 160px;
                max-width: 180px;
                padding: 15px;
            }

            .card-premios h3 {
                font-size: 0.95em;
                margin-bottom: 10px;
            }

            .premio-item {
                padding: 8px;
                font-size: 0.75em;
                margin-bottom: 8px;
            }

            h1 {
                font-size: 0.9em;
            }

            .info-participantes {
                font-size: 0.95em;
                padding: 8px 15px;
            }

            .roleta-wrapper {
                max-width: 240px;
            }

            .centro-roleta {
                width: 120px;
                height: 120px;
                padding: 15px;
            }

            .mensagem-aguardando {
                font-size: 0.65em;
            }

            .btn-girar {
                padding: 12px 30px;
                font-size: 1.1em;
            }

            .resultado {
                bottom: 15px;
                width: 85%;
                max-width: 400px;
                padding: 10px 15px;
            }
                    
            .resultado h2 {
                font-size: clamp(1em, 3.5vw, 1.3em);
                margin-bottom: 7px;
            }
            
            .resultado .ganhador {
                font-size: clamp(0.9em, 3vw, 1.2em);
                margin: 7px 0;
                padding: 6px;
            }
            
            .resultado .ganhador.nome-extra-longo {
                font-size: clamp(0.75em, 2.2vw, 0.95em) !important;
            }
            
            .resultado .premio {
                font-size: clamp(0.8em, 2.5vw, 1em);
                padding: 8px 10px;
            }
        }
 
        /* Mobile Pequeno */
        @media (max-width: 480px) {
            .topo-imagem {
                height: 100%;
            }

            .content-wrapper {
                gap: 3px;  /* ‚úÖ REDUZIDO de 8px para 5px */
                padding: 0px 5px;
            }

            .card-premios {
                min-width: 350px;
                height: 70px;
                padding: 3px;
                margin-top: 0;  /* ‚úÖ ADICIONAR - Remove espa√ßo superior */
                margin-bottom: 0;
            }

            .card-premios h3 {
                font-size: 0.8em;
                margin-bottom: 3px;  /* ‚úÖ REDUZIDO de 8px para 5px */
                margin-top: 0;  /* ‚úÖ ADICIONAR */
            }

            .premio-item {
                padding: 6px;
                font-size: 0.65em;
                margin-bottom: 6px;
            }

            h1 {
                font-size: 0.5em;
                margin-bottom: 5px;  /* ‚úÖ REDUZIDO de 8px para 5px */
            }

            .info-participantes {
                font-size: 0.7em;
                padding: 5px 10px;
                margin-bottom: 5px;  /* ‚úÖ REDUZIDO de 10px para 5px */
            }

            .roleta-wrapper {
                max-width: 210px;
                margin-bottom: 5px;  /* ‚úÖ REDUZIDO de 15px para 5px */
            }

            .centro-roleta {
                width: 70px;
                height: 70px;
                padding: 8px;
            }

            .mensagem-aguardando {
                font-size: 0.5em;
                line-height: 1.2;
            }

            .btn-girar {
                padding: 8px 20px;
                font-size: 0.85em;
                letter-spacing: 1px;
            }

            .resultado {
                bottom: 10px;
                width: 90%;
                max-width: 320px;
                padding: 8px 12px;
            }
            
            .resultado h2 {
                font-size: clamp(0.9em, 3vw, 1.1em);
                margin-bottom: 5px;
            }
            
            .resultado .ganhador {
                font-size: clamp(0.8em, 2.8vw, 1em);
                margin: 5px 0;
                padding: 5px;
                max-width: 100%;
            }
            
            .resultado .ganhador.nome-extra-longo {
                font-size: clamp(0.7em, 2vw, 0.85em) !important;
                line-height: 1.1;
                padding: 4px;
            }
            
            .resultado .premio {
                font-size: clamp(0.75em, 2.2vw, 0.9em);
                padding: 6px 8px;
            }

            .aviso {
                color: #fff;
                background: rgba(255,68,68,0.9);
                padding: 20px;
                border-radius: 15px;
                margin-top: 20px;
                font-size: 1.1em;
            }

            .loading {
                color: #fff;
                font-size: 1.2em;
                margin-top: 20px;
            }

        }

    </style>
</head>
<body>
    <!-- V√≠deo de Fundo -->
    <video id="video-fundo" autoplay loop muted playsinline>
        <source src="fundo roleta.mp4" type="video/mp4">
    </video>
    <div class="overlay-escuro"></div>
    
    <div class="main-wrapper">
        <!-- Imagem do Topo -->
        <img src="roleta topo.png" alt="Roleta Topo" class="topo-imagem">
        <div class="content-wrapper">
            <!-- ‚úÖ NOVA DIV: Envolve Roleta + Card -->
            <div class="roleta-e-card-wrapper">
                
                <!-- Coluna Principal: Roleta (AGORA √Ä ESQUERDA) -->
                <div class="container">
                    <h1 id="tituloRoleta" style="font-size: 0.2em;">üé° Roleta de Pr√™mios üé°</h1>
                    <div class="roleta-wrapper">
                        <div class="seta-indicador"></div>
                        <div class="roleta-container">
                            <canvas id="roletaCanvas"></canvas>
                            <div class="centro-roleta" id="centroRoleta">
                                <img src="logounisense.jpeg" alt="Logo Unisense" class="logo-roleta" id="logoRoleta">
                                <div class="mensagem-aguardando" id="mensagemAguardando" style="display:none;">
                                    A roleta vai come√ßar automaticamente quando alcan√ßar 50 participantes
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card: Pr√≥ximos Pr√™mios (AGORA √Ä DIREITA) -->
                    <div class="card-premios">
                        <h3>Pr√≥ximos Pr√™mios:</h3>
                        <div id="listaPremios">
                            <div class="sem-premios">Carregando...</div>
                        </div>
                    </div>

                    <div class="resultado" id="resultado">
                        <h2>üéâ PARAB√âNS! üéâ</h2>
                        <div class="ganhador" id="nomeGanhador"></div>
                        <div class="premio" id="premioGanhador"></div>
                    </div>

                    <div class="loading" id="loading" style="display:none;">
                        Carregando dados...
                    </div>
                </div>

            </div> <!-- Fecha roleta-e-card-wrapper -->
        </div> <!-- Fecha content-wrapper -->
                  
               

                <div class="resultado" id="resultado">
                    <h2> PARAB√âNS! </h2>
                    <div class="ganhador" id="nomeGanhador"></div>
                    <div class="premio" id="premioGanhador"></div>
                </div>

                <div class="loading" id="loading" style="display:none;">
                    Carregando dados...
                </div>
            </div>

            

    <script>
        // ============================================
        // VALIDA√á√ÉO DO CONFIG.JS
        // ============================================
        if (typeof CONFIG === 'undefined') {
            console.error('‚ùå CONFIG.js n√£o foi carregado!');
            alert('Erro: Sistema n√£o configurado corretamente. Recarregue a p√°gina.');
        } else {
            console.log('‚úÖ CONFIG.js carregado na roleta');
            console.log('üåê Dom√≠nio:', CONFIG.DOMAIN);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const isAutoSorteio = urlParams.get('auto') === 'true';
        const premioId = urlParams.get('premio_id');
        const premioNome = urlParams.get('premio_nome');

        // ============================================
        // SISTEMA DE POLLING PARA RECEBER COMANDOS
        // ============================================

        const POLLING_INTERVAL = 2000; // Verifica a cada 2 segundos
        let ultimoComandoTimestamp = 0;
        let pollingAtivo = true;

        // Fun√ß√£o auxiliar para logs com timestamp
        function logPolling(emoji, mensagem, dados = null) {
            const agora = new Date().toLocaleTimeString('pt-BR');
            console.log(`${emoji} [${agora}] ${mensagem}`, dados || '');
        }

        // Fun√ß√£o para verificar comandos pendentes
        async function verificarComandos() {
            if (!pollingAtivo) return;
            
            logPolling('üîç', 'Verificando comandos pendentes...');
            
            try {
                const response = await fetch(CONFIG.buildURL(CONFIG.API.VERIFICAR_COMANDO), {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    logPolling('‚ùå', `Erro na resposta: ${response.status}`);
                    return;
                }
                
                const data = await response.json();
                logPolling('üì®', 'Resposta recebida:', JSON.stringify(data));
                
                if (data.success && data.comando) {
                    const comando = data.comando;
                    logPolling('‚úÖ', 'Comando encontrado:', JSON.stringify(comando));
                    
                    // Verificar se √© um comando novo (evitar reprocessamento)
                    if (comando.timestamp && comando.timestamp !== ultimoComandoTimestamp) {
                        logPolling('üé∞', 'NOVO COMANDO DETECTADO! Processando...');
                        ultimoComandoTimestamp = comando.timestamp;
                        
                        // Processar comando
                        await processarComando(comando);
                        
                        // Limpar comando no servidor
                        try {
                            const limparResponse = await fetch(CONFIG.buildURL(CONFIG.API.LIMPAR_COMANDO), {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                }
                            });
                            
                            if (limparResponse.ok) {
                                logPolling('üßπ', 'Comando limpo no servidor');
                            } else {
                                logPolling('‚ö†Ô∏è', 'Erro ao limpar comando');
                            }
                        } catch (error) {
                            logPolling('‚ö†Ô∏è', 'Erro ao limpar comando:', error.message);
                        }
                    } else {
                        logPolling('‚è≠Ô∏è', 'Comando j√° foi processado, ignorando...');
                    }
                } else {
                    logPolling('‚è≥', 'Nenhum comando pendente');
                }
            } catch (error) {
                logPolling('‚ùå', 'Erro ao verificar comandos:', error.message);
            }
        }

        // Fun√ß√£o para processar o comando recebido
        async function processarComando(comando) {
            logPolling('‚öôÔ∏è', 'Processando comando:', JSON.stringify(comando));
            
            // Verificar tipo de comando
            if (comando.tipo === 'INICIAR_SORTEIO' || comando.acao === 'sortear') {
                logPolling('üéØ', 'Comando de sorteio detectado!');
                
                // Verificar se h√° participantes
                if (comando.participantes && Array.isArray(comando.participantes)) {
                    logPolling('üë•', `${comando.participantes.length} participantes recebidos`);
                    
                    // Recarregar dados para garantir que est√° atualizado
                    await carregarDados();
                    
                    // Aguardar 1 segundo para garantir que os dados foram carregados
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // INICIAR O SORTEIO AUTOMATICAMENTE
                    try {
                        // Verificar qual fun√ß√£o de sorteio existe
                        if (typeof girarRoleta === 'function') {
                            logPolling('üé∞', 'Chamando girarRoleta()...');
                            await girarRoleta();
                            logPolling('‚úÖ', 'Sorteio conclu√≠do!');
                        } else if (typeof girarRoletaAutomatico === 'function') {
                            logPolling('üé∞', 'Chamando girarRoletaAutomatico()...');
                            await girarRoletaAutomatico();
                            logPolling('‚úÖ', 'Sorteio autom√°tico conclu√≠do!');
                        } else if (typeof sortear === 'function') {
                            logPolling('üé∞', 'Chamando sortear()...');
                            await sortear();
                            logPolling('‚úÖ', 'Sorteio conclu√≠do!');
                        } else {
                            logPolling('‚ùå', 'Nenhuma fun√ß√£o de sorteio encontrada!');
                            
                            // Listar fun√ß√µes dispon√≠veis que contenham 'sort' ou 'gir'
                            const funcoesDisponiveis = Object.keys(window).filter(k => 
                                typeof window[k] === 'function' && 
                                (k.toLowerCase().includes('sort') || k.toLowerCase().includes('gir'))
                            );
                            logPolling('üí°', 'Fun√ß√µes dispon√≠veis:', funcoesDisponiveis.join(', '));
                        }
                    } catch (error) {
                        logPolling('‚ùå', 'Erro ao executar sorteio:', error.message);
                    }
                } else {
                    logPolling('‚ö†Ô∏è', 'Comando sem participantes v√°lidos');
                }
            } else {
                logPolling('‚ÑπÔ∏è', `Tipo de comando n√£o reconhecido: ${comando.tipo || 'undefined'}`);
            }
        }

        // Iniciar polling quando a p√°gina carregar
        function iniciarPolling() {
            logPolling('üöÄ', 'Iniciando sistema de polling...');
            logPolling('‚è±Ô∏è', `Intervalo: ${POLLING_INTERVAL}ms (${POLLING_INTERVAL/1000}s)`);
            
            // Primeira verifica√ß√£o imediata
            verificarComandos();
            
            // Verifica√ß√µes peri√≥dicas
            setInterval(verificarComandos, POLLING_INTERVAL);
            
            logPolling('‚úÖ', 'Polling ativo! Aguardando comandos...');
        }

        // Reconectar quando a p√°gina voltar do background (mobile)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                logPolling('üëÅÔ∏è', 'P√°gina voltou ao foreground - verificando comandos...');
                verificarComandos();
            }
        });

        // Reconectar quando a internet voltar
        window.addEventListener('online', () => {
            logPolling('üì∂', 'Internet reconectada - verificando comandos...');
            verificarComandos();
        });

        // Aguardar DOM estar pronto antes de iniciar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                logPolling('üìÑ', 'DOM carregado, iniciando polling em 500ms...');
                setTimeout(iniciarPolling, 500);
            });
        } else {
            logPolling('üìÑ', 'DOM j√° carregado, iniciando polling em 500ms...');
            setTimeout(iniciarPolling, 500);
        }

        logPolling('‚úÖ', 'Sistema de polling carregado e pronto!');

        const canvas = document.getElementById('roletaCanvas');
        const ctx = canvas.getContext('2d');
        
        let participantes = [];
        let premios = [];
        let girando = false;
        let anguloAtual = 0;
        let sorteiosComHorarios = []; // Armazena os sorteios com hor√°rios
        let filaPremios = []; // Fila de pr√™mios a serem sorteados

        const cores = ['#8B0000', '#FFFFFF', '#8B0000', '#FFFFFF', '#8B0000', '#FFFFFF', '#8B0000', '#FFFFFF'];

        // Configurar canvas responsivo
        function ajustarCanvas() {
            const container = canvas.parentElement;
            const size = Math.min(container.clientWidth, container.clientHeight);
            canvas.width = size;
            canvas.height = size;
            desenharRoleta();
        }

        window.addEventListener('resize', ajustarCanvas);
        ajustarCanvas();

        // Carregar participantes e pr√™mios
        async function carregarDados() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // ‚úÖ CONFIG.fetch j√° retorna JSON diretamente
                const [dataP, dataR] = await Promise.all([
                    CONFIG.fetch(CONFIG.API.PARTICIPANTES_ATIVOS),
                    CONFIG.fetch(CONFIG.API.SORTEIOS_AGENDADOS)
                ]);

                // ‚úÖ Processar participantes
                participantes = dataP.participantes || [];
                console.log('üë• Participantes carregados:', participantes.length);

                // ‚úÖ Processar sorteios
                console.log('üì¶ API sorteios-agendados retornou:', dataR);
                
                const listaSorteios = Array.isArray(dataR) ? dataR : (dataR.sorteios || []);
                console.log('üìã Lista de sorteios ANTES do filtro:', listaSorteios);
                
                // ‚úÖ FILTRAR APENAS OS SORTEIOS ATIVOS NO HOR√ÅRIO ATUAL
                const agora = new Date();
                
                // üÜï USAR TIMEZONE DE S√ÉO PAULO
                const agoraEmSP = new Date(agora.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
                
                const ano = agoraEmSP.getFullYear();
                const mes = String(agoraEmSP.getMonth() + 1).padStart(2, '0');
                const dia = String(agoraEmSP.getDate()).padStart(2, '0');
                const dataHoje = `${ano}-${mes}-${dia}`; // YYYY-MM-DD
                
                const horaAtual = String(agoraEmSP.getHours()).padStart(2, '0') + ':' + 
                                String(agoraEmSP.getMinutes()).padStart(2, '0'); // HH:MM
                
                console.log('üïê Data atual (SP):', dataHoje);
                console.log('üïê Hora atual (SP):', horaAtual);
                
                const sorteiosAtivos = listaSorteios.filter(sorteio => {
                    if (sorteio.status !== 'pendente') {
                        console.log('‚ùå Sorteio ignorado (status):', sorteio.id, sorteio.status);
                        return false;
                    }
                    
                    if (sorteio.data_sorteio !== dataHoje) {
                        console.log('‚ùå Sorteio ignorado (data):', sorteio.id, sorteio.data_sorteio, '!=', dataHoje);
                        return false;
                    }
                    
                    if (sorteio.hora_inicio_sorteio > horaAtual) {
                        console.log('‚ùå Sorteio ignorado (ainda n√£o come√ßou):', sorteio.id, sorteio.hora_inicio_sorteio);
                        return false;
                    }
                    
                    if (sorteio.hora_fim_sorteio < horaAtual) {
                        console.log('‚ùå Sorteio ignorado (j√° terminou):', sorteio.id, sorteio.hora_fim_sorteio);
                        return false;
                    }
                    
                    console.log('‚úÖ Sorteio ATIVO:', sorteio.id, sorteio.hora_inicio_sorteio, '-', sorteio.hora_fim_sorteio);
                    return true;
                });
                
                console.log(`üìä Total de sorteios: ${listaSorteios.length}`);
                console.log(`‚úÖ Sorteios ativos agora: ${sorteiosAtivos.length}`);
                
                // üÜï PROCESSAR PR√äMIOS CORRETAMENTE
                const premiosMap = new Map();
                const todosPremiosComHorario = [];
                
                sorteiosAtivos.forEach(sorteio => {
                    console.log('üîç Processando sorteio:', sorteio);
                    
                    let premiosDistribuicao = [];
                    
                    if (typeof sorteio.premios_distribuicao === 'string') {
                        try {
                            premiosDistribuicao = JSON.parse(sorteio.premios_distribuicao);
                        } catch (e) {
                            console.error('‚ùå Erro ao fazer parse:', e);
                        }
                    } else if (Array.isArray(sorteio.premios_distribuicao)) {
                        premiosDistribuicao = sorteio.premios_distribuicao;
                    }
                    
                    console.log('üéÅ Pr√™mios da distribui√ß√£o:', premiosDistribuicao);
                    
                    // üÜï ARMAZENAR TODOS OS PR√äMIOS COM HOR√ÅRIO
                    premiosDistribuicao.forEach(item => {
                        if (item.premio_nome) {
                            const premioObj = {
                                id: item.premio_id || 0,
                                nome: item.premio_nome,
                                horario_inicio: item.horario_inicio,
                                horario_fim: item.horario_fim
                            };
                            
                            // Adicionar ao mapa (sem duplicatas)
                            if (!premiosMap.has(item.premio_nome)) {
                                premiosMap.set(item.premio_nome, premioObj);
                            }
                            
                            // Adicionar √† lista completa (com hor√°rios)
                            todosPremiosComHorario.push(premioObj);
                        }
                    });
                });
                
                premios = Array.from(premiosMap.values());
                console.log('‚úÖ Pr√™mios √∫nicos extra√≠dos:', premios);
                console.log('üìã Todos pr√™mios com hor√°rio:', todosPremiosComHorario);

                // Carregar fila salva ou criar nova
                carregarFilaDoStorage();

                // Se a fila est√° vazia ou desatualizada, criar nova
                if (filaPremios.length === 0 || !filaEstaAtualizada(premios, filaPremios)) {
                    filaPremios = [...premios];
                    salvarFilaNoStorage();
                    console.log('üÜï Nova fila criada:', filaPremios.map(p => p.nome));
                }

                // üÜï ARMAZENAR LISTA COMPLETA COM HOR√ÅRIOS
                sorteiosComHorarios = todosPremiosComHorario;
                console.log('üì¶ Pr√™mios com hor√°rios armazenados:', sorteiosComHorarios);

                atualizarInfo();
                desenharRoleta();

                // üÜï GIRAR AUTOMATICAMENTE SE FOR SORTEIO AUTOM√ÅTICO
                if (isAutoSorteio && !girando && participantes.length > 0 && filaPremios.length > 0) {
                    console.log('‚è≥ Sorteio autom√°tico detectado! Iniciando em 2 segundos...');
                    setTimeout(() => {
                        girarRoleta();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                console.error('Stack trace:', error.stack);
                alert('Erro ao carregar dados. Recarregue a p√°gina.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function atualizarInfo() {
            // Atualizar lista de pr√™mios no card lateral
            atualizarListaPremios();
            
            // Iniciar rota√ß√£o de pr√™mios no t√≠tulo
            iniciarRotacaoPremios();
        }

        function atualizarListaPremios() {
            const container = document.getElementById('listaPremios');
            
            if (filaPremios.length === 0) {
                container.innerHTML = '<div class="sem-premios">Nenhum pr√™mio agendado</div>';
                return;
            }
            
            // Mostrar a fila na ordem (primeiro que ser√° sorteado aparece em cima)
            container.innerHTML = filaPremios.map((p, index) => 
                `<div class="premio-item ${index === 0 ? 'proximo-premio' : ''}">${p.nome}</div>`
            ).join('');
        }

        function iniciarRotacaoPremios() {
            const titulo = document.getElementById('tituloRoleta');
            
            // Inicializar fila se estiver vazia
            if (filaPremios.length === 0 && premios.length > 0) { 
                filaPremios = [...premios];
                salvarFilaNoStorage();
            }
            
            if (filaPremios.length === 0) {
                titulo.innerHTML = ' Aguardando pr√™mios agendados ';
                return;
            }
            
            // Mostrar o primeiro da fila
            const proximoPremio = filaPremios[0];
            titulo.innerHTML = ` <span class="premio-rotativo">${proximoPremio.nome}</span> `;
        }

        function moverPremioParaFinalDaFila() {
            if (filaPremios.length === 0) return;
            
            // Remove o primeiro e adiciona no final
            const premioSorteado = filaPremios.shift();
            filaPremios.push(premioSorteado);
            
            // Salvar fila atualizada
            salvarFilaNoStorage();
            
            // Atualizar visualmente
                atualizarListaPremios();
                iniciarRotacaoPremios();
                
                console.log('üîÑ Fila atualizada:', filaPremios.map(p => p.nome));
            }

            function salvarFilaNoStorage() {
                try {
                    localStorage.setItem('filaPremios', JSON.stringify(filaPremios));
                } catch (e) {
                    console.error('Erro ao salvar fila:', e);
                }
            }

            function carregarFilaDoStorage() {
                try {
                    const filaSalva = localStorage.getItem('filaPremios');
                    if (filaSalva) {
                        filaPremios = JSON.parse(filaSalva);
                        console.log('üìÇ Fila carregada do storage:', filaPremios.map(p => p.nome));
                    }
                } catch (e) {
                    console.error('Erro ao carregar fila:', e);
                    filaPremios = [];
                }
            }

            function filaEstaAtualizada(premiosAtuais, filaAtual) {
                // Verificar se a fila tem todos os pr√™mios atuais
                const nomesAtuais = premiosAtuais.map(p => p.nome).sort();
                const nomesFila = filaAtual.map(p => p.nome).sort();
                
                if (nomesAtuais.length !== nomesFila.length) return false;
                
                return nomesAtuais.every((nome, index) => nome === nomesFila[index]);
            }
                    
                    function desenharRoleta() {
                        // ‚úÖ ADICIONAR ESTES LOGS NO IN√çCIO DA FUN√á√ÉO
                        console.log('üé® desenharRoleta() chamada');
                        console.log('üë• Participantes dispon√≠veis:', participantes.length);
                        console.log('üìã Lista de participantes:', participantes);
                        
                        // Controlar exibi√ß√£o da logo/mensagem
                        const logoRoleta = document.getElementById('logoRoleta');
                        const mensagemAguardando = document.getElementById('mensagemAguardando');
                        
                        // ‚úÖ VALIDA√á√ÉO: Garantir que o canvas tem tamanho v√°lido
                        if (!canvas.width || !canvas.height || canvas.width < 20 || canvas.height < 20) {
                            console.warn('‚ö†Ô∏è Canvas com tamanho inv√°lido, ignorando desenho');
                            return;
                        }
                        
                        if (participantes.length === 0) {
                            console.log('‚ö†Ô∏è Nenhum participante - mostrando mensagem');
                            ctx.fillStyle = '#ddd';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // Mostrar mensagem, esconder logo
                            logoRoleta.style.display = 'none';
                            mensagemAguardando.style.display = 'block';
                            return;
                        } else {
                            console.log('‚úÖ Desenhando roleta com', participantes.length, 'participantes');
                            // Mostrar logo, esconder mensagem
                            logoRoleta.style.display = 'block';
                            mensagemAguardando.style.display = 'none';
                        }

                        const centerX = canvas.width / 2;
                        const centerY = canvas.height / 2;
                        
                        // ‚úÖ CORRE√á√ÉO CR√çTICA: Garantir que o raio nunca seja negativo
                        const radius = Math.max(20, canvas.width / 2 - 10);
                        
                        const sliceAngle = (Math.PI * 2) / participantes.length;

                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        participantes.forEach((participante, i) => {
                            const startAngle = anguloAtual + sliceAngle * i;
                            const endAngle = startAngle + sliceAngle;

                            // Desenhar fatia
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            
                            // ‚úÖ AGORA O RADIUS NUNCA SER√Å NEGATIVO
                            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                            ctx.closePath();
                            
                            // Adicionar transpar√™ncia (30% de opacidade)
                            const corBase = cores[i % cores.length];
                            ctx.fillStyle = corBase + '4D'; // 4D = 30% de opacidade em hexadecimal
                            ctx.fill();

                            // ‚úÖ DESENHAR TEXTO - ADICIONAR LOGS AQUI
                            ctx.save();
                            ctx.translate(centerX, centerY);
                            ctx.rotate(startAngle + sliceAngle / 2);
                            ctx.textAlign = 'right';

                            // Texto em bord√¥
                            ctx.fillStyle = '#8B0000';

                            // Ajustar tamanho da fonte baseado no tamanho do canvas
                            const fontSize = Math.max(10, Math.floor(canvas.width * 0.032));
                            ctx.font = `bold ${fontSize}px Montserrat`;
                            ctx.shadowColor = 'rgba(255,255,255,0.8)';
                            ctx.shadowBlur = 3;
                            ctx.shadowOffsetX = 1;
                            ctx.shadowOffsetY = 1;

                            const primeiroNome = participante.nome.split(' ')[0];
                            
                            console.log(`‚úèÔ∏è Desenhando nome na fatia ${i}:`, primeiroNome);
                            
                            // ‚úÖ VALIDA√á√ÉO: Garantir que o texto n√£o ser√° desenhado fora do canvas
                            const posicaoTexto = Math.max(30, radius - 20);
                            ctx.fillText(primeiroNome, posicaoTexto, 5);

                            ctx.restore();
                        });
                        
                        console.log('‚úÖ Roleta desenhada com sucesso!');
                    }

                // ============================================
                // SUBSTITUA A FUN√á√ÉO girarRoleta() ATUAL
                // POR ESTA VERS√ÉO CORRIGIDA
                // ============================================

                async function girarRoleta() {
                    // Garantir que a logo est√° vis√≠vel durante o giro
                    document.getElementById('logoRoleta').style.display = 'block';
                    document.getElementById('mensagemAguardando').style.display = 'none';
                    
                    if (girando) {
                        console.log('‚ö†Ô∏è Roleta j√° est√° girando, ignorando comando...');
                        return;
                    }
                    
                    if (participantes.length === 0) {
                        console.error('‚ùå Ainda n√£o h√° participantes cadastrados!');
                        alert('Ainda n√£o h√° participantes cadastrados!');
                        return;
                    }
                    
                    if (filaPremios.length === 0) {
                        console.error('‚ùå N√£o h√° pr√™mios dispon√≠veis!');
                        alert('N√£o h√° pr√™mios dispon√≠veis!');
                        return;
                    }

                    console.log('üé∞ Iniciando sorteio da roleta...');
                    console.log('üë• Total de participantes:', participantes.length);
                    console.log('üéÅ Pr√™mios na fila:', filaPremios.length);

                    girando = true;
                    document.getElementById('resultado').classList.remove('ativo');

                    try {
                        // Sorteio sincronizado usando timestamp como seed
                        const seed = Date.now();
                        const indiceVencedor = seed % participantes.length;
                        const vencedor = participantes[indiceVencedor];
                        const premioSorteado = filaPremios[0];

                        console.log('üéØ Seed usado:', seed);
                        console.log('üéØ √çndice do vencedor:', indiceVencedor);
                        console.log('üéØ Vencedor sorteado:', vencedor.nome);
                        console.log('üéÅ Pr√™mio sorteado:', premioSorteado.nome);

                        // Calcular √¢ngulo final
                        const sliceAngle = (Math.PI * 2) / participantes.length;
                        const anguloVencedor = sliceAngle * indiceVencedor + sliceAngle / 2;
                        const anguloSeta = -Math.PI / 2;
                        const rotacoesCompletas = Math.PI * 2 * 5;
                        const anguloFinal = rotacoesCompletas - anguloVencedor + anguloSeta;

                        // Anima√ß√£o
                        const duracao = 5000;
                        const inicio = Date.now();

                        function animar() {
                            const agora = Date.now();
                            const progresso = Math.min((agora - inicio) / duracao, 1);
                            const easeOut = 1 - Math.pow(1 - progresso, 3);
                            
                            anguloAtual = anguloFinal * easeOut;
                            desenharRoleta();

                            if (progresso < 1) {
                                requestAnimationFrame(animar);
                            } else {
                                console.log('‚úÖ Anima√ß√£o da roleta conclu√≠da!');
                                mostrarResultado(vencedor, premioSorteado);
                            }
                        }

                        animar();
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao executar sorteio:', error);
                        alert('Erro ao executar sorteio. Tente novamente.');
                        girando = false;
                    }
                }

                async function mostrarResultado(vencedor, premio) {
                    console.log('üéØ mostrarResultado recebeu:');
                    console.log('  Vencedor:', vencedor);
                    console.log('  Premio:', premio);
                    
                    document.getElementById('nomeGanhador').textContent = vencedor.nome;
                    document.getElementById('premioGanhador').textContent = `üéÅ ${premio.nome}`;
                    document.getElementById('resultado').classList.add('ativo');

                    // üéØ REGISTRAR GANHADOR DA ROLETA
                    try {
                        const dadosRegistro = {
                            participante: {
                                nome: String(vencedor.nome || ''),
                                email: String(vencedor.email || ''),
                                whatsapp: String(vencedor.whatsapp || '')
                            },
                            premio: {
                                id: Number(premio.id) || 0,
                                nome: String(premio.nome || 'Pr√™mio')
                            },
                            tipo_sorteio: 'roleta'
                        };
                        
                        console.log('üì§ Enviando registro:', JSON.stringify(dadosRegistro, null, 2));
                        
                        const response = await CONFIG.fetch(CONFIG.API.REGISTRAR_SORTEIO, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json' 
                            },
                            body: JSON.stringify(dadosRegistro)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('‚úÖ Ganhador da roleta registrado com sucesso!', data);
                        } else {
                            const errorText = await response.text();
                            console.error('‚ùå Erro HTTP', response.status, ':', errorText);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao registrar ganhador:', error);
                    }

                    // üÜï ENVIAR RESULTADO PARA O ADMIN (SE VEIO DO SORTEIO AUTOM√ÅTICO)
                    if (isAutoSorteio && window.opener) {
                        console.log('üì§ Enviando resultado para o admin...');
                        
                        window.opener.postMessage({
                            type: 'SORTEIO_CONCLUIDO',
                            vencedor: {
                                id: vencedor.id,
                                nome: vencedor.nome,
                                email: vencedor.email,
                                whatsapp: vencedor.whatsapp
                            },
                            premio_id: premioId,
                            premio_nome: premioNome
                        }, window.location.origin);
                        
                        console.log('‚úÖ Resultado enviado! Fechando em 5 segundos...');
                        
                        // Fechar a janela ap√≥s 5 segundos
                        setTimeout(() => {
                            window.close();
                        }, 5000);
                        
                        return; // N√£o continua o resto do c√≥digo
                    }

                    // Enviar resultado para o parent (modo iframe - manter compatibilidade)
                    try {
                        window.parent.postMessage({
                            action: 'resultadoRoleta',
                            vencedor: {
                                nome: vencedor.nome,
                                email: vencedor.email
                            },
                            premio: {
                                nome: premio.nome
                            }
                        }, '*');
                    } catch (e) {
                        console.error('Erro no postMessage:', e);
                    }

                    // üÜï OCULTAR RESULTADO AUTOMATICAMENTE AP√ìS 2 SEGUNDOS
                    setTimeout(() => {
                        document.getElementById('resultado').classList.remove('ativo');
                        moverPremioParaFinalDaFila();
                        girando = false;
                    }, 2000);
                }

        // ========================================
        // ADICIONAR NO FINAL DO <script> da roleta.html
        // ANTES de "carregarDados();"
        // ========================================

        // 
        // Verificar configura√ß√£o do sorteio autom√°tico
        async function verificarSorteioAutomatico() {
            console.log('üîÑ Verificando sorteio autom√°tico...');
            
            try {
                const sorteios = await CONFIG.fetch(CONFIG.API.SORTEIOS_AGENDADOS);
                console.log('üìä Sorteios agendados:', sorteios);
                
                if (!Array.isArray(sorteios) || sorteios.length === 0) {
                    console.log('‚ÑπÔ∏è Nenhum sorteio agendado');
                    return;
                }
                
                const sorteioAtivo = sorteios.find(s => s.ativo === 1);
                
                if (!sorteioAtivo) {
                    console.log('‚ÑπÔ∏è Nenhum sorteio ativo encontrado');
                    return;
                }
                
                console.log('‚úÖ Sorteio ativo encontrado:', sorteioAtivo);
                
                // Verificar se atingiu o n√∫mero de participantes
                const participantes = await CONFIG.fetch(CONFIG.API.PARTICIPANTES);
                
                const totalParticipantes = participantes.filter(p => p.sorteado === 0).length;
                
                console.log(`üë• Participantes: ${totalParticipantes}/${sorteioAtivo.participantes_necessarios}`);
                
                if (totalParticipantes >= sorteioAtivo.participantes_necessarios) {
                    console.log('üéâ N√∫mero de participantes atingido! Iniciando sorteio...');
                    await realizarSorteio(sorteioAtivo.id);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar sorteio autom√°tico:', error);
            }
        }

        // ============================================
// 3Ô∏è‚É£ SUBSTITUIR girarRoleta() NO HTML DA ROLETA
// ============================================

async function girarRoleta() {
    // Garantir que a logo est√° vis√≠vel durante o giro
    document.getElementById('logoRoleta').style.display = 'block';
    document.getElementById('mensagemAguardando').style.display = 'none';
    
    if (girando) {
        console.log('‚ö†Ô∏è Roleta j√° est√° girando, ignorando comando...');
        return;
    }
    
    if (participantes.length === 0) {
        console.error('‚ùå Ainda n√£o h√° participantes cadastrados!');
        return;
    }
    
    if (premios.length === 0) {
        console.error('‚ùå N√£o h√° pr√™mios dispon√≠veis!');
        return;
    }

    console.log('üé∞ Iniciando sorteio da roleta SINCRONIZADO...');
    console.log('üë• Total de participantes:', participantes.length);
    console.log('üéÅ Pr√™mios dispon√≠veis:', premios.length);

    girando = true;
    document.getElementById('resultado').classList.remove('ativo');

    try {
        // üÜï SOLICITAR SORTEIO SINCRONIZADO DO SERVIDOR
        console.log('üì° Solicitando sorteio sincronizado ao servidor...');
        
        const response = await fetch(CONFIG.buildURL(CONFIG.API.GERAR_SORTEIO_SINCRONIZADO), {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                total_participantes: participantes.length,
                premio_id: filaPremios[0].id,
                premio_nome: filaPremios[0].nome
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || 'Erro ao gerar sorteio');
        }

        const sorteioData = data.sorteio;
        console.log('‚úÖ Sorteio sincronizado recebido:', sorteioData);

        // Usar o √≠ndice retornado pelo servidor
        const indiceVencedor = sorteioData.indice_vencedor;
        const vencedor = participantes[indiceVencedor];
        const premioSorteado = filaPremios[0];

        console.log('üéØ Seed do servidor:', sorteioData.seed);
        console.log('üéØ √çndice do vencedor:', indiceVencedor);
        console.log('üéØ Vencedor sorteado:', vencedor.nome);
        console.log('üéÅ Pr√™mio sorteado:', premioSorteado.nome);

        // Calcular √¢ngulo final
        const sliceAngle = (Math.PI * 2) / participantes.length;
        const anguloVencedor = sliceAngle * indiceVencedor + sliceAngle / 2;
        const anguloSeta = -Math.PI / 2;
        const rotacoesCompletas = Math.PI * 2 * 5;
        const anguloFinal = rotacoesCompletas - anguloVencedor + anguloSeta;

        // Anima√ß√£o
        const duracao = 5000;
        const inicio = Date.now();

        function animar() {
            const agora = Date.now();
            const progresso = Math.min((agora - inicio) / duracao, 1);
            const easeOut = 1 - Math.pow(1 - progresso, 3);
            
            anguloAtual = anguloFinal * easeOut;
            desenharRoleta();

            if (progresso < 1) {
                requestAnimationFrame(animar);
            } else {
                console.log('‚úÖ Anima√ß√£o da roleta conclu√≠da!');
                mostrarResultado(vencedor, premioSorteado);
            }
        }

        animar();
        
    } catch (error) {
        console.error('‚ùå Erro ao executar sorteio sincronizado:', error);
        alert('Erro ao executar sorteio. Tente novamente.');
        girando = false;
    }
}

async function processarComando(comando) {
    logPolling('‚öôÔ∏è', 'Processando comando:', JSON.stringify(comando));
    
    // Verificar tipo de comando
    if (comando.tipo === 'INICIAR_SORTEIO' || comando.acao === 'sortear') {
        logPolling('üéØ', 'Comando de sorteio detectado!');
        
        // Verificar se h√° participantes
        if (comando.participantes && Array.isArray(comando.participantes)) {
            logPolling('üë•', `${comando.participantes.length} participantes recebidos`);
            
            // Recarregar dados para garantir que est√° atualizado
            await carregarDados();
            
            // Aguardar 1 segundo para garantir que os dados foram carregados
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // INICIAR O SORTEIO AUTOMATICAMENTE
            try {
                logPolling('üé∞', 'Chamando girarRoleta()...');
                await girarRoleta();
                logPolling('‚úÖ', 'Sorteio conclu√≠do!');
            } catch (error) {
                logPolling('‚ùå', 'Erro ao executar sorteio:', error.message);
            }
        } else {
            logPolling('‚ö†Ô∏è', 'Comando sem participantes v√°lidos');
        }
    } else {
        logPolling('‚ÑπÔ∏è', `Tipo de comando n√£o reconhecido: ${comando.tipo || 'undefined'}`);
    }
}

// ============================================
// 5Ô∏è‚É£ NOVA FUN√á√ÉO: executarSorteioSincronizado()
// ============================================

async function executarSorteioSincronizado(comando) {
    logPolling('üéØ', 'Executando sorteio sincronizado:', comando);
    
    // Recarregar dados para garantir que est√° atualizado
    await carregarDados();
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (participantes.length === 0) {
        logPolling('‚ùå', 'Nenhum participante dispon√≠vel');
        return;
    }
    
    const indiceVencedor = comando.indice_vencedor;
    const vencedor = participantes[indiceVencedor];
    
    if (!vencedor) {
        logPolling('‚ùå', 'Vencedor n√£o encontrado no √≠ndice', indiceVencedor);
        return;
    }
    
    logPolling('‚úÖ', 'Vencedor sincronizado:', vencedor.nome);
    
    // Garantir que a logo est√° vis√≠vel
    document.getElementById('logoRoleta').style.display = 'block';
    document.getElementById('mensagemAguardando').style.display = 'none';
    
    // Animar roleta
    girando = true;
    document.getElementById('resultado').classList.remove('ativo');
    
    const sliceAngle = (Math.PI * 2) / participantes.length;
    const anguloVencedor = sliceAngle * indiceVencedor + sliceAngle / 2;
    const anguloSeta = -Math.PI / 2;
    const rotacoesCompletas = Math.PI * 2 * 5;
    const anguloFinal = rotacoesCompletas - anguloVencedor + anguloSeta;
    
    const duracao = 5000;
    const inicio = Date.now();
    
    function animar() {
        const agora = Date.now();
        const progresso = Math.min((agora - inicio) / duracao, 1);
        const easeOut = 1 - Math.pow(1 - progresso, 3);
        
        anguloAtual = anguloFinal * easeOut;
        desenharRoleta();
        
        if (progresso < 1) {
            requestAnimationFrame(animar);
        } else {
            logPolling('üéâ', 'Anima√ß√£o conclu√≠da!');
            mostrarResultado(vencedor, filaPremios[0]);
        }
    }
    
    animar();
}


        // Mostrar resultado do sorteio autom√°tico
        async function mostrarResultadoAutomatico(vencedor, premio) {
            console.log('üéâ SORTEIO AUTOM√ÅTICO CONCLU√çDO!');
            console.log('  Vencedor:', vencedor.nome);
            console.log('  Premio:', premio.nome);
            
            document.getElementById('nomeGanhador').textContent = vencedor.nome;
            document.getElementById('premioGanhador').textContent = `üéÅ ${premio.nome}`;
            document.getElementById('resultado').classList.add('ativo');

            // Mover pr√™mio para o final da fila
            moverPremioParaFinalDaFila();
            
            // Recarregar participantes (o vencedor j√° foi marcado como sorteado pela API)
            await carregarDados();
            
            // Aguardar 5 segundos e resetar
            setTimeout(() => {
                document.getElementById('resultado').classList.remove('ativo');
                girando = false;
                
                // Verificar novamente ap√≥s 5 segundos
                setTimeout(verificarSorteioAutomatico, 5000);
            }, 5000);
        }

        // Iniciar verifica√ß√£o peri√≥dica (a cada 10 segundos)
        setInterval(verificarSorteioAutomatico, 10000);

        // Verificar imediatamente ao carregar
        setTimeout(verificarSorteioAutomatico, 3000);    

        // Carregar dados ao iniciar
        carregarDados();

        // Recarregar a cada 30 segundos
        setInterval(carregarDados, 30000);

        // ============================================
        // RECEBER SORTEIO AUTOM√ÅTICO DO PAINEL ADMIN
        // ============================================

        window.addEventListener('message', async function(event) {
            console.log('üì® Mensagem recebida:', event.data);
            
            // Verificar origem (seguran√ßa b√°sica)
            if (event.origin !== window.location.origin) {
                console.warn('‚ö†Ô∏è Mensagem de origem n√£o confi√°vel:', event.origin);
                return;
            }

            const dados = event.data;

            if (dados.tipo === 'INICIAR_SORTEIO_AUTOMATICO') {
                console.log('üé∞ Sorteio autom√°tico recebido do painel admin:', dados);

                const participante = dados.participante;
                const premio = dados.premio;

                // Validar dados recebidos
                if (!participante || !premio) {
                    console.error('‚ùå Dados inv√°lidos recebidos:', { participante, premio });
                    return;
                }

                console.log('‚úÖ Dados validados:', { participante, premio });

                // Aguardar 2 segundos para garantir que a p√°gina carregou
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Recarregar participantes para ter certeza que o sorteado est√° na lista
                await carregarDados();

                // Aguardar mais 1 segundo ap√≥s carregar dados
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Verificar se o participante sorteado est√° na lista
                const participanteNaLista = participantes.find(p => 
                    p.id === participante.id || p.email === participante.email || p.nome === participante.nome
                );

                if (!participanteNaLista) {
                    console.error('‚ùå Participante sorteado n√£o est√° na lista de participantes');
                    console.log('Participante procurado:', participante);
                    console.log('Participantes dispon√≠veis:', participantes);
                    
                    // Adicionar participante manualmente √† lista
                    participantes.push({
                        id: participante.id,
                        nome: participante.nome,
                        email: participante.email,
                        whatsapp: participante.whatsapp || ''
                    });
                    
                    console.log('‚ö†Ô∏è Participante adicionado manualmente √† lista');
                    desenharRoleta();
                }

                console.log('‚úÖ Participante encontrado/adicionado na lista:', participanteNaLista || participante);
                console.log('üéÅ Pr√™mio a ser mostrado:', premio);

                // For√ßar o pr√™mio na fila (colocar no in√≠cio)
                const premioNaFila = filaPremios.find(p => p.id === premio.id || p.nome === premio.nome);

                if (premioNaFila) {
                    // Remove o pr√™mio da posi√ß√£o atual
                    filaPremios = filaPremios.filter(p => p.id !== premio.id && p.nome !== premio.nome);
                    // Adiciona no in√≠cio
                    filaPremios.unshift(premioNaFila);
                    salvarFilaNoStorage();
                    atualizarListaPremios();
                    iniciarRotacaoPremios();
                    console.log('‚úÖ Pr√™mio movido para o in√≠cio da fila');
                } else {
                    console.warn('‚ö†Ô∏è Pr√™mio n√£o encontrado na fila, adicionando manualmente');
                    filaPremios.unshift({
                        id: premio.id,
                        nome: premio.nome
                    });
                    salvarFilaNoStorage();
                    atualizarListaPremios();
                    iniciarRotacaoPremios();
                    console.log('‚úÖ Pr√™mio adicionado manualmente no in√≠cio da fila');
                }

                // Aguardar 1 segundo para visualizar a atualiza√ß√£o
                await new Promise(resolve => setTimeout(resolve, 1000));

                // INICIAR O SORTEIO
                console.log('üé¨ Iniciando anima√ß√£o da roleta...');
                await girarRoletaComResultado(participanteNaLista || participante, premioNaFila || premio);
            }
        });

        console.log('‚úÖ Listener de sorteio autom√°tico configurado e pronto');

        // Nova fun√ß√£o: girar roleta com resultado pr√©-determinado
        async function girarRoletaComResultado(vencedor, premio) {
            if (girando) {
                console.log('‚ö†Ô∏è Roleta j√° est√° girando');
                return;
            }

            console.log('üé∞ Iniciando anima√ß√£o da roleta COM RESULTADO PR√â-DETERMINADO');
            console.log('  Vencedor:', vencedor);
            console.log('  Pr√™mio:', premio);

            // Garantir que a logo est√° vis√≠vel
            document.getElementById('logoRoleta').style.display = 'block';
            document.getElementById('mensagemAguardando').style.display = 'none';

            girando = true;
            document.getElementById('resultado').classList.remove('ativo');

            // Encontrar o √≠ndice do vencedor
            const indiceVencedor = participantes.findIndex(p => 
                p.id === vencedor.id || p.email === vencedor.email || p.nome === vencedor.nome
            );

            if (indiceVencedor === -1) {
                console.error('‚ùå Vencedor n√£o encontrado na lista de participantes');
                girando = false;
                return;
            }

            console.log(`‚úÖ Vencedor encontrado no √≠ndice ${indiceVencedor}`);

            // Calcular √¢ngulo final
            const sliceAngle = (Math.PI * 2) / participantes.length;
            const anguloVencedor = sliceAngle * indiceVencedor + sliceAngle / 2;
            const anguloSeta = -Math.PI / 2;
            const rotacoesCompletas = Math.PI * 2 * 5;
            const anguloFinal = rotacoesCompletas - anguloVencedor + anguloSeta;

            // Anima√ß√£o
            const duracao = 5000;
            const inicio = Date.now();

            function animar() {
                const agora = Date.now();
                const progresso = Math.min((agora - inicio) / duracao, 1);
                const easeOut = 1 - Math.pow(1 - progresso, 3);

                anguloAtual = anguloFinal * easeOut;
                desenharRoleta();

                if (progresso < 1) {
                    requestAnimationFrame(animar);
                } else {
                    console.log('üéâ Anima√ß√£o conclu√≠da!');
                    mostrarResultado(vencedor, premio);
                }
            }

            animar();
        }

        // ============================================
        // AJUSTE AUTOM√ÅTICO PARA NOMES LONGOS
        // ============================================

        // Observar quando o resultado for exibido
        const observadorResultado = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList && mutation.target.classList.contains('resultado')) {
                    const ganhadorElemento = mutation.target.querySelector('.ganhador');
                    
                    if (ganhadorElemento && mutation.target.classList.contains('ativo')) {
                        const textoGanhador = ganhadorElemento.textContent || '';
                        const comprimento = textoGanhador.length;
                        
                        console.log('üìè Nome do ganhador tem', comprimento, 'caracteres');
                        
                        // Se o nome for extremamente longo (mais de 30 caracteres)
                        if (comprimento > 15) {
                            ganhadorElemento.classList.add('nome-extra-longo');
                            console.log('‚úÖ Classe "nome-extra-longo" adicionada');
                        } else {
                            ganhadorElemento.classList.remove('nome-extra-longo');
                        }
                    }
                }
            });
        });

        // Iniciar observa√ß√£o quando a p√°gina carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                const resultadoDiv = document.getElementById('resultado');
                if (resultadoDiv) {
                    observadorResultado.observe(resultadoDiv, { 
                        attributes: true, 
                        attributeFilter: ['class'] 
                    });
                    console.log('üëÅÔ∏è Observador de resultado configurado');
                }
            });
        } else {
            const resultadoDiv = document.getElementById('resultado');
            if (resultadoDiv) {
                observadorResultado.observe(resultadoDiv, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
                console.log('üëÅÔ∏è Observador de resultado configurado');
            }
        }       
        
    </script>
    
</body>
</html>
